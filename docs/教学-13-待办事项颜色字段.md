# æ•™å­¦ Part 13: å¾…åŠäº‹é¡¹é¢œè‰²å­—æ®µ

> **ğŸ“Œ å­¦ä¹ é˜¶æ®µ**: åˆçº§ / æ•°æ®åº“è¿ç§»
> **å‰ç½®è¦æ±‚**: å·²å®Œæˆæ•™å­¦-12ï¼ˆç®€å•ç¼“å­˜å±‚ï¼‰
> **å­¦ä¹ ç›®æ ‡**: ç†è§£æ•°æ®åº“è¿ç§»ã€å¤„ç† NULL å€¼ã€ä¿æŒå‘åå…¼å®¹
> **æ—¶é—´æŠ•å…¥**: 1-2 å°æ—¶ï¼ˆç†è§£åŸç† + å®ç° + æµ‹è¯•ï¼‰

---

## ğŸ¯ åŠŸèƒ½åˆ†æ - Linus å¼æ€è€ƒ

### Linus çš„ä¸‰ä¸ªé—®é¢˜

**1. "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ"**

âœ… **çœŸå®é—®é¢˜**ï¼š
- å½“å‰é¢œè‰²æ˜¯å‰ç«¯é€šè¿‡ CSS `:nth-child` æŒ‰ä½ç½®å¾ªç¯åˆ†é…
- åˆ é™¤æˆ–æ–°å¢ Todo åï¼Œç°æœ‰ Todo çš„é¢œè‰²ä¼šå‘ç”Ÿå˜åŒ–
- ç”¨æˆ·å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆæˆ‘çš„ä»»åŠ¡é¢œè‰²å˜äº†ï¼Ÿ"

**çœŸå®åœºæ™¯**ï¼š
```
åˆå§‹çŠ¶æ€ï¼š
  [é»„è‰²] ä»»åŠ¡A
  [ç»¿è‰²] ä»»åŠ¡B
  [ç²‰è‰²] ä»»åŠ¡C

åˆ é™¤ä»»åŠ¡Båï¼š
  [é»„è‰²] ä»»åŠ¡A
  [ç»¿è‰²] ä»»åŠ¡C  â† é¢œè‰²å˜äº†ï¼ç”¨æˆ·ï¼šä¸ºä»€ä¹ˆä»»åŠ¡Cå˜æˆç»¿è‰²äº†ï¼Ÿ
```

**ç›®æ ‡**ï¼šè®©æ¯ä¸ªå¾…åŠäº‹é¡¹åœ¨åˆ›å»ºæ—¶å°±å›ºå®šä¸€ä¸ªé¢œè‰²ï¼Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­ã€‚

**2. "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ"**

ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼šæ•°æ®åº“æ·»åŠ  `color` å­—æ®µ

**ç¬¨æ–¹æ³•**ï¼ˆå‰ç«¯ç»´æŠ¤é¢œè‰²æ˜ å°„ï¼‰ï¼š
```javascript
// âŒ å¤æ‚ä¸”å®¹æ˜“å‡ºé”™
const colorMap = {
  1: '#FFE066',
  2: '#7DFFAF',
  // ...éœ€è¦ç»´æŠ¤æ¯ä¸ª ID çš„é¢œè‰²
}
```

**èªæ˜æ–¹æ³•**ï¼ˆåç«¯å­˜å‚¨é¢œè‰²ï¼‰ï¼š
```go
// âœ… ç®€å•ï¼šé¢œè‰²æ˜¯ Todo çš„å±æ€§
type Todo struct {
    // ...
    Color string `json:"color,omitempty"`
}
```

**3. "ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ"**

âš ï¸ **æ½œåœ¨é£é™©**ï¼š
- æ—§æ•°æ®æ²¡æœ‰ `color` å­—æ®µ â†’ `NULL` å€¼å¤„ç†
- å‰ç«¯ä¸ä¼  `color` â†’ åç«¯è¦å®¹é”™
- è¿ç§»å¤±è´¥ â†’ æœåŠ¡æ— æ³•å¯åŠ¨

âœ… **å®‰å…¨è®¾è®¡**ï¼š
- ä½¿ç”¨ `sql.NullString` å¤„ç† NULL å€¼
- `color` å­—æ®µå¯é€‰ï¼ˆ`omitempty`ï¼‰
- è¿ç§»å¹‚ç­‰ï¼ˆé‡å¤æ‰§è¡Œä¸æŠ¥é”™ï¼‰
- å‰ç«¯å¯¹æ—§æ•°æ®æ ¹æ® ID è®¡ç®—é»˜è®¤é¢œè‰²

---

## ğŸ“š æ ¸å¿ƒçŸ¥è¯†è®²è§£

### 1. SQLite çš„ NULL å€¼å¤„ç†

**é—®é¢˜**ï¼šGo çš„ `string` ç±»å‹ä¸èƒ½ç›´æ¥æ¥æ”¶ `NULL` å€¼

```go
// âŒ ä¼š panic æˆ–è¿”å›é”™è¯¯
var color string
err := row.Scan(&color)  // å¦‚æœæ•°æ®åº“å€¼æ˜¯ NULLï¼Œä¼šå¤±è´¥
```

**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨ `sql.NullString`

```go
// âœ… æ­£ç¡®å¤„ç† NULL
var color sql.NullString
err := row.Scan(&color)

if color.Valid {
    todo.Color = color.String  // æœ‰å€¼
} else {
    todo.Color = ""  // NULLï¼Œä¿æŒç©ºå­—ç¬¦ä¸²
}
```

**sql.NullString ç»“æ„**ï¼š
```go
type NullString struct {
    String string  // å®é™…å€¼
    Valid  bool    // æ˜¯å¦é NULL
}
```

---

### 2. æ•°æ®åº“è¿ç§»çš„å¹‚ç­‰æ€§

**å¹‚ç­‰æ€§**ï¼šå¤šæ¬¡æ‰§è¡Œäº§ç”Ÿç›¸åŒç»“æœ

```go
// âœ… å¹‚ç­‰ï¼šæ¯æ¬¡æ‰§è¡Œå‰æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
func (db *DB) ensureColorColumn() error {
    // 1. æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
    if hasColumn("color") {
        return nil  // å·²å­˜åœ¨ï¼Œè·³è¿‡
    }

    // 2. ä¸å­˜åœ¨åˆ™æ·»åŠ 
    db.Exec("ALTER TABLE todos ADD COLUMN color TEXT")
}
```

**ä¸ºä»€ä¹ˆéœ€è¦å¹‚ç­‰ï¼Ÿ**
- æœåŠ¡å¯èƒ½å¤šæ¬¡é‡å¯
- å¤šå®ä¾‹éƒ¨ç½²æ—¶å¯èƒ½å¹¶å‘æ‰§è¡Œ
- å¼€å‘ç¯å¢ƒå¯èƒ½åå¤å¯åŠ¨

---

### 3. ALTER TABLE çš„é™åˆ¶

**SQLite çš„ ALTER TABLE é™åˆ¶**ï¼š
- âœ… å¯ä»¥æ·»åŠ åˆ—
- âœ… å¯ä»¥é‡å‘½åè¡¨
- âŒ ä¸èƒ½åˆ é™¤åˆ—ï¼ˆéœ€è¦é‡å»ºè¡¨ï¼‰
- âŒ ä¸èƒ½ä¿®æ”¹åˆ—ç±»å‹ï¼ˆéœ€è¦é‡å»ºè¡¨ï¼‰

**æ·»åŠ åˆ—çš„è¯­æ³•**ï¼š
```sql
-- æ·»åŠ å…è®¸ NULL çš„åˆ—
ALTER TABLE todos ADD COLUMN color TEXT

-- æ·»åŠ å¸¦é»˜è®¤å€¼çš„åˆ—
ALTER TABLE todos ADD COLUMN color TEXT DEFAULT '#FFE066'

-- æ·»åŠ éç©ºåˆ—ï¼ˆæ—§æ•°æ®å¿…é¡»æœ‰é»˜è®¤å€¼ï¼‰
ALTER TABLE todos ADD COLUMN color TEXT NOT NULL DEFAULT '#FFE066'
```

**æœ¬é¡¹ç›®é€‰æ‹©**ï¼šå…è®¸ NULLï¼Œä¸è®¾é»˜è®¤å€¼
- æ—§æ•°æ®ä¿æŒ NULL
- å‰ç«¯æ ¹æ® ID è®¡ç®—é»˜è®¤é¢œè‰²
- æœ€ç®€å•ä¸”å‘åå…¼å®¹

---

### 4. å‘åå…¼å®¹è®¾è®¡

**å‰ç«¯å…¼å®¹**ï¼š
```typescript
// ä¼˜å…ˆä½¿ç”¨ Todo è‡ªå¸¦çš„é¢œè‰²
// å¯¹äºæ²¡æœ‰ color å­—æ®µçš„æ—§æ•°æ®ï¼Œæ ¹æ® ID è®¡ç®—é»˜è®¤é¢œè‰²
const getColor = (todo: Todo) => {
    if (todo.color) return todo.color
    return TODO_COLORS[todo.id % TODO_COLORS.length]
}
```

**åç«¯å…¼å®¹**ï¼š
```go
type Todo struct {
    // color å­—æ®µå¯é€‰ï¼Œæ—§æ•°æ®ä¸ºç©ºå­—ç¬¦ä¸²
    Color string `json:"color,omitempty"`
}
```

**API å…¼å®¹**ï¼š
```json
// æ–°æ•°æ®ï¼ˆæœ‰é¢œè‰²ï¼‰
{"id": 1, "title": "ä»»åŠ¡", "color": "#FFE066"}

// æ—§æ•°æ®ï¼ˆæ— é¢œè‰²ï¼‰
{"id": 2, "title": "ä»»åŠ¡"}  // color å­—æ®µä¸å‡ºç°
```

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

### æ–‡ä»¶ 1: `model/todo.go` - æ·»åŠ  Color å­—æ®µ

> **å½“å‰ç»“æ„ä½“ä½ç½®**ï¼š`model/todo.go:8-18`

```go
// Todo è¡¨ç¤ºä¸€ä¸ªå¾…åŠäº‹é¡¹
type Todo struct {
    ID          int        `json:"id"`
    Version     int        `json:"version"`
    Title       string     `json:"title"`
    Description string     `json:"description"`
    Status      string     `json:"status"` // pending, completed
    Color       string     `json:"color,omitempty"`  // æ–°å¢ï¼šå¾…åŠäº‹é¡¹é¢œè‰²
    DueDate     *time.Time `json:"due_date,omitempty"`
    CreatedAt   time.Time  `json:"created_at"`
    UpdatedAt   time.Time  `json:"updated_at"`
    CompletedAt *time.Time `json:"completed_at,omitempty"`
}
```

> **å½“å‰ NewTodo ä½ç½®**ï¼š`model/todo.go:21-31`

```go
// NewTodo åˆ›å»ºä¸€ä¸ªæ–°çš„å¾…åŠäº‹é¡¹
func NewTodo(title, description, color string) *Todo {
    now := time.Now()
    return &Todo{
        Version:     1,
        Title:       title,
        Description: description,
        Status:      "pending",
        Color:       color,  // æ–°å¢
        CreatedAt:   now,
        UpdatedAt:   now,
    }
}
```

---

### æ–‡ä»¶ 2: `handler/handler.go` - ä¿®æ”¹è¯·æ±‚ç»“æ„ä½“

> **å½“å‰ CreateTodoRequest ä½ç½®**ï¼š`handler/handler.go:25-29`

```go
// CreateTodoRequest åˆ›å»ºå¾…åŠäº‹é¡¹è¯·æ±‚ä½“
type CreateTodoRequest struct {
    Title       string `json:"title" example:"Buy groceries"`
    Description string `json:"description" example:"Milk, bread, and fruits"`
    Color       string `json:"color" example:"#FFE066"`  // æ–°å¢
}
```

> **ä¿®æ”¹ CreateTodo å‡½æ•°**ï¼ˆæ‰¾åˆ°è°ƒç”¨ `model.NewTodo` çš„ä½ç½®ï¼‰

```go
// åŸæ¥çš„ä»£ç ï¼š
// todo := model.NewTodo(req.Title, req.Description)

// æ”¹ä¸ºï¼š
todo := model.NewTodo(req.Title, req.Description, req.Color)
```

---

### æ–‡ä»¶ 3: `database/db.go` - æ•°æ®åº“è¿ç§»

> **å‚è€ƒç°æœ‰çš„ ensureVersionColumn å®ç°**ï¼š`database/db.go:69-113`

**æ·»åŠ  ensureColorColumn å‡½æ•°**ï¼š

```go
// ensureColorColumn ç¡®ä¿ color åˆ—å­˜åœ¨ï¼ˆæ•°æ®åº“è¿ç§»ï¼‰
func (db *DB) ensureColorColumn() error {
    rows, err := db.conn.Query(`PRAGMA table_info(todos);`)
    if err != nil {
        return fmt.Errorf("failed to inspect todos table: %w", err)
    }
    defer rows.Close()

    hasColorColumn := false
    for rows.Next() {
        var (
            cid        int
            name       string
            dataType   string
            notNull    int
            defaultVal sql.NullString
            pk         int
        )
        if err := rows.Scan(&cid, &name, &dataType, &notNull, &defaultVal, &pk); err != nil {
            return fmt.Errorf("failed to scan todos schema: %w", err)
        }
        if name == "color" {
            hasColorColumn = true
            break
        }
    }

    if err := rows.Err(); err != nil {
        return fmt.Errorf("failed to iterate todos schema: %w", err)
    }

    if hasColorColumn {
        return nil  // åˆ—å·²å­˜åœ¨ï¼Œæ— éœ€è¿ç§»
    }

    // æ·»åŠ  color åˆ—ï¼ˆå…è®¸ NULLï¼Œæ—§æ•°æ®ä¸éœ€è¦é»˜è®¤å€¼ï¼‰
    alterStmt := `ALTER TABLE todos ADD COLUMN color TEXT`
    if _, err := db.conn.Exec(alterStmt); err != nil {
        return fmt.Errorf("failed to add color column: %w", err)
    }

    log.Println("Database migration: added 'color' column to todos table")
    return nil
}
```

> **åœ¨ initSchema ä¸­è°ƒç”¨**ï¼š`database/db.go:42-67`

```go
func (db *DB) initSchema() error {
    schema := `...`

    if _, err := db.conn.Exec(schema); err != nil {
        return err
    }

    // ç°æœ‰çš„è¿ç§»
    if err := db.ensureVersionColumn(); err != nil {
        return err
    }

    // æ–°å¢ï¼šé¢œè‰²åˆ—è¿ç§»
    if err := db.ensureColorColumn(); err != nil {
        return err
    }

    return nil
}
```

---

### æ–‡ä»¶ 4: `database/db.go` - ä¿®æ”¹ CRUD æ“ä½œ

#### 4.1 ä¿®æ”¹ CreateTodo

> **å½“å‰ä½ç½®**ï¼š`database/db.go:120-148`

```go
func (db *DB) CreateTodo(todo *model.Todo) error {
    query := `
        INSERT INTO todos (title, description, status, color, due_date, created_at, updated_at, version)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
    `

    result, err := db.conn.Exec(
        query,
        todo.Title,
        todo.Description,
        todo.Status,
        todo.Color,  // æ–°å¢
        todo.DueDate,
        todo.CreatedAt,
        todo.UpdatedAt,
        todo.Version,
    )
    if err != nil {
        return fmt.Errorf("failed to create todo: %w", err)
    }

    id, err := result.LastInsertId()
    if err != nil {
        return fmt.Errorf("failed to get last insert id: %w", err)
    }

    todo.ID = int(id)
    return nil
}
```

#### 4.2 ä¿®æ”¹ ListTodos

> **éœ€è¦ä¿®æ”¹çš„ä½ç½®**ï¼š
> - SELECT è¯­å¥ï¼ˆæ·»åŠ  color å­—æ®µï¼‰
> - Scan è°ƒç”¨ï¼ˆæ·»åŠ  color å˜é‡ï¼‰

```go
// ä¿®æ”¹ baseQueryï¼ˆæ·»åŠ  color å­—æ®µï¼‰
baseQuery := `
    SELECT id, version, title, description, status, color,
           due_date, created_at, updated_at, completed_at
    FROM todos
    WHERE deleted_at IS NULL
`

// ä¿®æ”¹ Scanï¼ˆå¤„ç†å¯èƒ½ä¸º NULL çš„ colorï¼‰
for rows.Next() {
    var todo model.Todo
    var dueDate, completedAt sql.NullString
    var color sql.NullString  // æ–°å¢ï¼šå¤„ç†å¯èƒ½ä¸º NULL çš„ color

    err := rows.Scan(
        &todo.ID,
        &todo.Version,
        &todo.Title,
        &todo.Description,
        &todo.Status,
        &color,  // æ–°å¢
        &dueDate,
        &todo.CreatedAt,
        &todo.UpdatedAt,
        &completedAt,
    )
    if err != nil {
        return nil, 0, fmt.Errorf("æ‰«æå¤±è´¥: %w", err)
    }

    // å¤„ç† color NULL å€¼
    if color.Valid {
        todo.Color = color.String
    }

    // ... åç»­ dueDate å’Œ completedAt å¤„ç†ä¸å˜
    todos = append(todos, todo)
}
```

#### 4.3 ä¿®æ”¹ GetTodoByID

> **å½“å‰ä½ç½®**ï¼šæŸ¥æ‰¾ `GetTodoByID` å‡½æ•°

```go
func (db *DB) GetTodoByID(id int) (*model.Todo, error) {
    query := `
        SELECT id, version, title, description, status, color,
               due_date, created_at, updated_at, completed_at
        FROM todos
        WHERE id = ? AND deleted_at IS NULL
    `

    var todo model.Todo
    var dueDate, completedAt sql.NullString
    var color sql.NullString  // æ–°å¢

    err := db.conn.QueryRow(query, id).Scan(
        &todo.ID,
        &todo.Version,
        &todo.Title,
        &todo.Description,
        &todo.Status,
        &color,  // æ–°å¢
        &dueDate,
        &todo.CreatedAt,
        &todo.UpdatedAt,
        &completedAt,
    )

    if err == sql.ErrNoRows {
        return nil, nil
    }
    if err != nil {
        return nil, fmt.Errorf("failed to get todo: %w", err)
    }

    // å¤„ç† color NULL å€¼
    if color.Valid {
        todo.Color = color.String
    }

    // ... åç»­ dueDate å’Œ completedAt å¤„ç†ä¸å˜

    return &todo, nil
}
```

---

## âš ï¸ å…³é”®ç‚¹è§£æ

### 1. ä¸ºä»€ä¹ˆ color å­—æ®µç”¨ `sql.NullString`ï¼Ÿ

SQLite ä¸­æ–°å¢çš„åˆ—å¯¹äºæ—§æ•°æ®ä¼šæ˜¯ `NULL`ã€‚Go çš„ `string` ç±»å‹ä¸èƒ½ç›´æ¥æ¥æ”¶ `NULL` å€¼ï¼Œä¼šå¯¼è‡´ scan é”™è¯¯ã€‚

```go
// âŒ ä¼šæŠ¥é”™
var color string
rows.Scan(&color)  // error: sql: Scan error on column index X, name "color": converting NULL to string

// âœ… æ­£ç¡®
var color sql.NullString
rows.Scan(&color)
if color.Valid {
    todo.Color = color.String
}
```

### 2. ä¸ºä»€ä¹ˆä¸ç»™ color è®¾ç½®é»˜è®¤å€¼ï¼Ÿ

**æ–¹æ¡ˆå¯¹æ¯”**ï¼š

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| é»˜è®¤å€¼ | æ—§æ•°æ®æœ‰é¢œè‰² | æ‰€æœ‰æ—§æ•°æ®é¢œè‰²ç›¸åŒ |
| æ— é»˜è®¤å€¼ | å‰ç«¯å¯æ ¹æ® ID è®¡ç®—ä¸åŒé¢œè‰² | éœ€è¦å¤„ç† NULL |

**æœ¬é¡¹ç›®é€‰æ‹©æ— é»˜è®¤å€¼**ï¼š
- æ—§æ•°æ®æ ¹æ® ID è®¡ç®—é¢œè‰²ï¼Œæ¯ä¸ªéƒ½ä¸åŒ
- æ–°æ•°æ®ç”±å‰ç«¯éšæœºåˆ†é…é¢œè‰²

### 3. è¿ç§»çš„å¹‚ç­‰æ€§ä¿è¯

```go
// æ¯æ¬¡å¯åŠ¨éƒ½ä¼šæ‰§è¡Œï¼Œä½†åªæœ‰ç¬¬ä¸€æ¬¡ä¼šçœŸæ­£æ·»åŠ åˆ—
if hasColorColumn {
    return nil  // å¹‚ç­‰ï¼šå·²å­˜åœ¨åˆ™è·³è¿‡
}
```

---

## ğŸ› ï¸ å®ç°æ­¥éª¤å»ºè®®

### æ¸è¿›å¼å®ç°ï¼ˆåˆ† 4 æ­¥ï¼‰

**ç¬¬ 1 æ­¥**ï¼šä¿®æ”¹ Model

1. åœ¨ `Todo` ç»“æ„ä½“æ·»åŠ  `Color` å­—æ®µ
2. ä¿®æ”¹ `NewTodo` å‡½æ•°ç­¾åï¼Œæ·»åŠ  `color` å‚æ•°

æµ‹è¯•ï¼š
```go
todo := model.NewTodo("æµ‹è¯•", "æè¿°", "#FFE066")
fmt.Println(todo.Color)  // #FFE066
```

---

**ç¬¬ 2 æ­¥**ï¼šä¿®æ”¹ Handler

1. åœ¨ `CreateTodoRequest` æ·»åŠ  `Color` å­—æ®µ
2. ä¿®æ”¹ `CreateTodo` è°ƒç”¨ `NewTodo` æ—¶ä¼ å…¥ `req.Color`

---

**ç¬¬ 3 æ­¥**ï¼šæ·»åŠ æ•°æ®åº“è¿ç§»

1. åˆ›å»º `ensureColorColumn` å‡½æ•°
2. åœ¨ `initSchema` ä¸­è°ƒç”¨
3. é‡å¯æœåŠ¡ï¼ŒæŸ¥çœ‹è¿ç§»æ—¥å¿—

æµ‹è¯•ï¼š
```bash
go run cmd/server/main.go
# åº”è¯¥çœ‹åˆ°ï¼šDatabase migration: added 'color' column to todos table

# å†æ¬¡å¯åŠ¨ï¼ˆéªŒè¯å¹‚ç­‰æ€§ï¼‰
go run cmd/server/main.go
# ä¸åº”è¯¥å†çœ‹åˆ°è¿ç§»æ—¥å¿—
```

---

**ç¬¬ 4 æ­¥**ï¼šä¿®æ”¹ CRUD æ“ä½œ

1. ä¿®æ”¹ `CreateTodo` çš„ INSERT è¯­å¥
2. ä¿®æ”¹ `ListTodos` çš„ SELECT å’Œ Scan
3. ä¿®æ”¹ `GetTodoByID` çš„ SELECT å’Œ Scan
4. å¦‚æœ‰å…¶ä»–è¯»å– Todo çš„åœ°æ–¹ï¼Œä¹Ÿéœ€è¦ä¿®æ”¹

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### å®Œæ•´æµ‹è¯•è„šæœ¬

```bash
#!/bin/bash

BASE_URL="http://localhost:7789/api/v1/todos"

echo "=== 1. å¯åŠ¨æœåŠ¡å¹¶æ£€æŸ¥è¿ç§»æ—¥å¿— ==="
echo "è¯·æ‰‹åŠ¨æ‰§è¡Œ: go run cmd/server/main.go"
echo "åº”è¯¥çœ‹åˆ°: Database migration: added 'color' column to todos table"
read -p "æŒ‰å›è½¦ç»§ç»­..."

echo -e "\n=== 2. åˆ›å»ºå¸¦é¢œè‰²çš„ Todo ==="
curl -s -X POST "$BASE_URL" \
  -H "Content-Type: application/json" \
  -d '{"title": "æµ‹è¯•é¢œè‰²", "color": "#FFE066"}' | jq '.'

echo -e "\n=== 3. åˆ›å»ºä¸å¸¦é¢œè‰²çš„ Todoï¼ˆæµ‹è¯•å¯é€‰æ€§ï¼‰==="
curl -s -X POST "$BASE_URL" \
  -H "Content-Type: application/json" \
  -d '{"title": "æ— é¢œè‰²ä»»åŠ¡"}' | jq '.'

echo -e "\n=== 4. è·å–åˆ—è¡¨ï¼ŒéªŒè¯ color å­—æ®µ ==="
curl -s "$BASE_URL" | jq '.data.todos[] | {id, title, color}'

echo -e "\n=== 5. å‘åå…¼å®¹æµ‹è¯•ï¼ˆ/api/todos/ï¼‰==="
curl -s "http://localhost:7789/api/todos" | jq '.data.todos[0] | {id, title, color}'

echo -e "\n=== 6. åˆ é™¤ä¸­é—´çš„ Todoï¼ŒéªŒè¯å…¶ä»–é¢œè‰²ä¸å˜ ==="
echo "è¯·åœ¨å‰ç«¯æµ‹è¯•ï¼šåˆ é™¤ä¸€ä¸ª Todoï¼Œè§‚å¯Ÿå…¶ä»– Todo çš„é¢œè‰²æ˜¯å¦å˜åŒ–"
```

ä¿å­˜ä¸º `scripts/test-color.sh`ï¼Œç„¶åæ‰§è¡Œï¼š
```bash
chmod +x scripts/test-color.sh
./scripts/test-color.sh
```

### å‰ç«¯æµ‹è¯•

```bash
cd frontend && npm run dev
```

1. åˆ›å»ºæ–° Todoï¼Œè§‚å¯Ÿé¢œè‰²
2. åˆ é™¤ä¸­é—´çš„ Todoï¼ŒéªŒè¯å…¶ä»– Todo é¢œè‰²ä¸å˜
3. åˆ·æ–°é¡µé¢ï¼ŒéªŒè¯é¢œè‰²æŒä¹…åŒ–
4. æ£€æŸ¥æ—§æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰æ˜¯å¦æ ¹æ® ID æ˜¾ç¤ºä¸åŒé¢œè‰²

---

## âœ… éªŒè¯æ¸…å•

å®ç°å®Œæˆåï¼Œè¯·æ£€æŸ¥ï¼š

**Model ä¿®æ”¹**ï¼š
- [ ] `Todo` ç»“æ„ä½“æ·»åŠ  `Color` å­—æ®µ
- [ ] `Color` ä½¿ç”¨ `json:"color,omitempty"` æ ‡ç­¾
- [ ] `NewTodo` å‡½æ•°ç­¾åæ·»åŠ  `color` å‚æ•°
- [ ] `NewTodo` æ­£ç¡®è®¾ç½® `Color` å­—æ®µ

**Handler ä¿®æ”¹**ï¼š
- [ ] `CreateTodoRequest` æ·»åŠ  `Color` å­—æ®µ
- [ ] `CreateTodo` è°ƒç”¨ `NewTodo` æ—¶ä¼ å…¥ `req.Color`

**æ•°æ®åº“è¿ç§»**ï¼š
- [ ] åˆ›å»º `ensureColorColumn` å‡½æ•°
- [ ] ä½¿ç”¨ `PRAGMA table_info` æ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨
- [ ] è¿ç§»å¹‚ç­‰ï¼ˆé‡å¤æ‰§è¡Œä¸æŠ¥é”™ï¼‰
- [ ] åœ¨ `initSchema` ä¸­è°ƒç”¨è¿ç§»
- [ ] è¿ç§»æ—¥å¿—æ­£ç¡®è¾“å‡º

**CRUD æ“ä½œ**ï¼š
- [ ] `CreateTodo` INSERT è¯­å¥æ·»åŠ  `color`
- [ ] `ListTodos` SELECT è¯­å¥æ·»åŠ  `color`
- [ ] `ListTodos` Scan ä½¿ç”¨ `sql.NullString` å¤„ç† NULL
- [ ] `GetTodoByID` SELECT è¯­å¥æ·»åŠ  `color`
- [ ] `GetTodoByID` Scan ä½¿ç”¨ `sql.NullString` å¤„ç† NULL

**å‘åå…¼å®¹**ï¼š
- [ ] æ—§æ•°æ® `color` ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆä¸æŠ¥é”™ï¼‰
- [ ] API å“åº”ä¸­æ—§æ•°æ®ä¸åŒ…å« `color` å­—æ®µï¼ˆomitemptyï¼‰
- [ ] å‰ç«¯å¯¹æ—  `color` çš„æ•°æ®æ ¹æ® ID è®¡ç®—é»˜è®¤é¢œè‰²

**ä»£ç è´¨é‡**ï¼š
- [ ] ä½¿ç”¨ `log.Println` è¾“å‡ºè¿ç§»æ—¥å¿—ï¼ˆä¸é¡¹ç›®é£æ ¼ä¸€è‡´ï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œå–„ï¼ˆä½¿ç”¨ `fmt.Errorf` åŒ…è£…ï¼‰
- [ ] ä»£ç æ ¼å¼ç¬¦åˆ gofmt

---

## ğŸ’¡ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸åœ¨åç«¯éšæœºç”Ÿæˆé¢œè‰²ï¼Ÿ

**ç­”**ï¼š
- å‰ç«¯å·²ç»æœ‰é¢œè‰²åˆ—è¡¨ï¼Œè®©å‰ç«¯è´Ÿè´£é€‰æ‹©æ›´åˆç†
- åç«¯åªè´Ÿè´£å­˜å‚¨ï¼Œä¿æŒç®€å•
- å¦‚æœåç«¯ç”Ÿæˆï¼Œéœ€è¦åŒæ­¥é¢œè‰²åˆ—è¡¨åˆ°åç«¯

### Q2: å¦‚æœå‰ç«¯ä¸ä¼  color æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼š
- `req.Color` ä¸ºç©ºå­—ç¬¦ä¸²
- å­˜å…¥æ•°æ®åº“ä¸ºç©ºå­—ç¬¦ä¸²ï¼ˆä¸æ˜¯ NULLï¼‰
- å‰ç«¯æ˜¾ç¤ºæ—¶æ ¹æ® ID è®¡ç®—é»˜è®¤é¢œè‰²

### Q3: å¯ä»¥è®©ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹é¢œè‰²å—ï¼Ÿ

**ç­”**ï¼š
- ç›®å‰è®¾è®¡ä¸æ”¯æŒä¿®æ”¹é¢œè‰²
- å¦‚éœ€æ”¯æŒï¼Œéœ€è¦ï¼š
  1. ä¿®æ”¹ `UpdateTodoRequest` æ·»åŠ  `Color` å­—æ®µ
  2. ä¿®æ”¹ `UpdateTodo` çš„ UPDATE è¯­å¥
  3. å‰ç«¯æ·»åŠ é¢œè‰²é€‰æ‹©å™¨

### Q4: é¢œè‰²éªŒè¯åº”è¯¥åœ¨å“ªé‡Œåšï¼Ÿ

**ç­”**ï¼š
- ç®€å•é¡¹ç›®ï¼šä¸éªŒè¯ï¼Œä¿¡ä»»å‰ç«¯
- ç”Ÿäº§é¡¹ç›®ï¼šåç«¯éªŒè¯é¢œè‰²æ ¼å¼
  ```go
  func isValidColor(color string) bool {
      if color == "" {
          return true  // å…è®¸ç©º
      }
      matched, _ := regexp.MatchString(`^#[0-9A-Fa-f]{6}$`, color)
      return matched
  }
  ```

### Q5: å¦‚æœè¿ç§»å¤±è´¥æ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼š
- è¿ç§»å‡½æ•°è¿”å›é”™è¯¯
- `initSchema` è¿”å›é”™è¯¯
- `database.New` è¿”å›é”™è¯¯
- æœåŠ¡å¯åŠ¨å¤±è´¥ï¼Œæ‰“å°é”™è¯¯ä¿¡æ¯
- ä¿®å¤é—®é¢˜åé‡æ–°å¯åŠ¨

---

## ğŸ“– æ‰©å±•é˜…è¯»

### SQLite
- [ALTER TABLE æ–‡æ¡£](https://www.sqlite.org/lang_altertable.html)
- [PRAGMA table_info](https://www.sqlite.org/pragma.html#pragma_table_info)

### Go æ•°æ®åº“
- [sql.NullString æ–‡æ¡£](https://pkg.go.dev/database/sql#NullString)
- [database/sql æ•™ç¨‹](https://go.dev/doc/database/querying)

### æ•°æ®åº“è¿ç§»
- [Go è¿ç§»å·¥å…· migrate](https://github.com/golang-migrate/migrate)
- [SQLite è¿ç§»æœ€ä½³å®è·µ](https://www.sqlite.org/lang_altertable.html#making_other_kinds_of_table_schema_changes)

---

## ğŸš€ å¼€å§‹å®ç°å§ï¼

ç°åœ¨è¯·ä½ æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ï¼š

1. **ä¿®æ”¹ `model/todo.go`**ï¼š
   - æ·»åŠ  `Color` å­—æ®µåˆ° `Todo` ç»“æ„ä½“
   - ä¿®æ”¹ `NewTodo` å‡½æ•°ç­¾åï¼Œæ·»åŠ  `color` å‚æ•°

2. **ä¿®æ”¹ `handler/handler.go`**ï¼š
   - æ·»åŠ  `Color` å­—æ®µåˆ° `CreateTodoRequest`
   - ä¿®æ”¹ `CreateTodo` è°ƒç”¨ `NewTodo` æ—¶ä¼ å…¥ `req.Color`

3. **ä¿®æ”¹ `database/db.go`**ï¼š
   - æ·»åŠ  `ensureColorColumn` è¿ç§»å‡½æ•°
   - åœ¨ `initSchema` ä¸­è°ƒç”¨ `ensureColorColumn`
   - ä¿®æ”¹ `CreateTodo` çš„ INSERT è¯­å¥
   - ä¿®æ”¹ `ListTodos` çš„ SELECT å’Œ Scan
   - ä¿®æ”¹ `GetTodoByID` çš„ SELECT å’Œ Scan

4. **æµ‹è¯•**ï¼š
   - å¯åŠ¨æœåŠ¡ï¼Œè§‚å¯Ÿè¿ç§»æ—¥å¿—
   - åˆ›å»ºæ–° Todoï¼ŒéªŒè¯é¢œè‰²å­˜å‚¨
   - è·å–åˆ—è¡¨ï¼ŒéªŒè¯é¢œè‰²è¿”å›
   - å‰ç«¯æµ‹è¯•é¢œè‰²æŒä¹…åŒ–

**è®°ä½**ï¼š
- ä½¿ç”¨ `sql.NullString` å¤„ç† NULL å€¼
- è¿ç§»è¦å¹‚ç­‰ï¼ˆæ£€æŸ¥åˆ—æ˜¯å¦å­˜åœ¨ï¼‰
- `Color` å­—æ®µä½¿ç”¨ `omitempty`ï¼ˆæ—§æ•°æ®ä¸æ˜¾ç¤ºï¼‰

é‡åˆ°é—®é¢˜éšæ—¶é—®æˆ‘ï¼
