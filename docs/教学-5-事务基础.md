# æ•™å­¦ Part 5: äº‹åŠ¡åŸºç¡€

> **ğŸ“Œ å­¦ä¹ é˜¶æ®µ**: ä¸­çº§ / Go æ•°æ®åº“ç¼–ç¨‹
> **å‰ç½®è¦æ±‚**: å·²æŒæ¡åŸºç¡€ CRUDã€SQL æŸ¥è¯¢
> **å­¦ä¹ ç›®æ ‡**: ç†è§£äº‹åŠ¡ ACIDã€æŒæ¡ Go äº‹åŠ¡ä½¿ç”¨ã€å®ç°ç®€å•æ‰¹é‡æ“ä½œ
> **æ—¶é—´æŠ•å…¥**: 3-4 å°æ—¶(ç†è§£åŸç† + å®ç° + æµ‹è¯•)

---

## ğŸ¯ åŠŸèƒ½åˆ†æ - Linus å¼æ€è€ƒ

### Linus çš„ä¸‰ä¸ªé—®é¢˜

**1. "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ"**

âœ… **çœŸå®é—®é¢˜**ï¼š
- ç”¨æˆ·é€‰æ‹©äº† 10 ä¸ªå¾…åŠäº‹é¡¹è¦åˆ é™¤ï¼Œå…¶ä¸­ç¬¬ 5 ä¸ªåˆ é™¤å¤±è´¥äº†
- ç»“æœï¼šå‰ 4 ä¸ªè¢«åˆ é™¤ï¼Œå 5 ä¸ªè¿˜åœ¨ â†’ æ•°æ®ä¸ä¸€è‡´ï¼
- ç”¨æˆ·å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆåªåˆ äº†ä¸€éƒ¨åˆ†ï¼Ÿ"

**ä¸ºä»€ä¹ˆéœ€è¦äº‹åŠ¡ï¼Ÿ**
- **åŸå­æ€§**: è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
- **ä¸€è‡´æ€§**: ä¿æŒæ•°æ®å®Œæ•´æ€§
- **éš”ç¦»æ€§**: å¹¶å‘æ“ä½œä¸äº’ç›¸å¹²æ‰°

**2. "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ"**

ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼šä½¿ç”¨æ•°æ®åº“äº‹åŠ¡

**æ²¡æœ‰äº‹åŠ¡çš„é—®é¢˜**:
```go
// âŒ éƒ¨åˆ†å¤±è´¥ä¼šå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
for _, id := range ids {
    db.Exec("DELETE FROM todos WHERE id = ?", id)  // ç¬¬5ä¸ªå¤±è´¥
    // å‰4ä¸ªå·²åˆ é™¤ï¼Œæ— æ³•å›æ»šï¼
}
```

**æœ‰äº‹åŠ¡çš„è§£å†³æ–¹æ¡ˆ**:
```go
// âœ… å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
tx, _ := db.Begin()
for _, id := range ids {
    if err := tx.Exec("DELETE..."); err != nil {
        tx.Rollback()  // æ’¤é”€æ‰€æœ‰æ“ä½œ
        return err
    }
}
tx.Commit()  // å…¨éƒ¨æˆåŠŸæ‰æäº¤
```

**3. "ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ"**

âœ… **å®‰å…¨è®¾è®¡**ï¼š
- äº‹åŠ¡é»˜è®¤ä¼šå›æ»šï¼ˆå¦‚æœå¿˜è®° Commitï¼‰
- SQLite æœ‰é»˜è®¤è¶…æ—¶ï¼ˆ5ç§’ï¼‰
- äº‹åŠ¡æ˜¯è¿æ¥çº§åˆ«çš„ï¼Œä¸å½±å“å…¶ä»–è¿æ¥

---

## ğŸ“š æ ¸å¿ƒçŸ¥è¯†è®²è§£

### 1. äº‹åŠ¡çš„ ACID ç‰¹æ€§

ACID æ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››å¤§ä¿è¯ï¼Œè®©æˆ‘ä»¬é€šè¿‡ä¾‹å­ç†è§£ï¼š

#### A - Atomicityï¼ˆåŸå­æ€§ï¼‰
**"è¦ä¹ˆå…¨åšï¼Œè¦ä¹ˆå…¨ä¸åš"**

```go
// åœºæ™¯ï¼šè½¬è´¦ 100 å…ƒï¼ˆAè´¦æˆ· -100ï¼ŒBè´¦æˆ· +100ï¼‰
tx.Begin()
tx.Exec("UPDATE accounts SET balance = balance - 100 WHERE id = 'A'")  // âœ…
tx.Exec("UPDATE accounts SET balance = balance + 100 WHERE id = 'B'")  // âŒ å¤±è´¥
tx.Rollback()  // Aè´¦æˆ·çš„é’±ä¹Ÿä¼šæ¢å¤ï¼Œä¸ä¼šå‡­ç©ºæ¶ˆå¤±100å…ƒ
```

#### C - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰
**"å§‹ç»ˆæ»¡è¶³ä¸šåŠ¡è§„åˆ™"**

```go
// è§„åˆ™ï¼šè´¦æˆ·ä½™é¢ä¸èƒ½ä¸ºè´Ÿ
tx.Begin()
tx.Exec("UPDATE accounts SET balance = -100")  // âŒ è¿åçº¦æŸ
tx.Commit()  // å¤±è´¥ï¼æ•°æ®åº“æ‹’ç»è¿™ç§ä¸ä¸€è‡´çš„çŠ¶æ€
```

#### I - Isolationï¼ˆéš”ç¦»æ€§ï¼‰
**"äº‹åŠ¡ä¹‹é—´ä¸äº’ç›¸å¹²æ‰°"**

```go
// äº‹åŠ¡Aå’Œäº‹åŠ¡BåŒæ—¶æ‰§è¡Œ
// äº‹åŠ¡A: è¯»å– balance = 1000
// äº‹åŠ¡B: ä¿®æ”¹ balance = 500ï¼ˆæœªæäº¤ï¼‰
// äº‹åŠ¡A: å†æ¬¡è¯»å– balance = 1000ï¼ˆçœ‹ä¸åˆ°Bçš„ä¿®æ”¹ï¼‰
```

#### D - Durabilityï¼ˆæŒä¹…æ€§ï¼‰
**"æäº¤åæ°¸ä¹…ä¿å­˜"**

```go
tx.Commit()  // âœ… æˆåŠŸ
// å³ä½¿æ­¤æ—¶æ–­ç”µï¼Œæ•°æ®ä¹Ÿå·²ç»å†™å…¥ç£ç›˜
```

---

### 2. Go ä¸­çš„äº‹åŠ¡åŸºæœ¬æ“ä½œ

#### å¼€å¯äº‹åŠ¡
```go
tx, err := db.Begin()
if err != nil {
    return fmt.Errorf("å¼€å¯äº‹åŠ¡å¤±è´¥: %w", err)
}
```

#### æ‰§è¡Œæ“ä½œ
```go
_, err = tx.Exec("DELETE FROM todos WHERE id = ?", id)
if err != nil {
    tx.Rollback()  // å‡ºé”™æ—¶å›æ»š
    return fmt.Errorf("åˆ é™¤å¤±è´¥: %w", err)
}
```

#### æäº¤æˆ–å›æ»š
```go
// æäº¤äº‹åŠ¡
if err := tx.Commit(); err != nil {
    return fmt.Errorf("æäº¤äº‹åŠ¡å¤±è´¥: %w", err)
}

// æˆ–è€…å›æ»š
if err := tx.Rollback(); err != nil {
    // Rollback ä¹Ÿå¯èƒ½å¤±è´¥ï¼ˆå¦‚è¿æ¥å·²æ–­å¼€ï¼‰
    log.Printf("å›æ»šå¤±è´¥: %v", err)
}
```

---

### 3. äº‹åŠ¡çš„æ ‡å‡†æ¨¡å¼

**æ¨èæ¨¡å¼**ï¼šä½¿ç”¨ defer ç¡®ä¿æ¸…ç†

```go
func DeleteMultipleTodos(db *sql.DB, ids []int) error {
    // 1. å¼€å¯äº‹åŠ¡
    tx, err := db.Begin()
    if err != nil {
        return fmt.Errorf("å¼€å¯äº‹åŠ¡å¤±è´¥: %w", err)
    }

    // 2. ç¡®ä¿äº‹åŠ¡è¢«æ­£ç¡®å¤„ç†
    defer func() {
        if err != nil {
            tx.Rollback()  // æœ‰é”™è¯¯æ—¶å›æ»š
            return
        }
        err = tx.Commit()  // æ— é”™è¯¯æ—¶æäº¤
    }()

    // 3. æ‰§è¡Œä¸šåŠ¡é€»è¾‘
    for _, id := range ids {
        _, err = tx.Exec("DELETE FROM todos WHERE id = ?", id)
        if err != nil {
            return fmt.Errorf("åˆ é™¤ ID %d å¤±è´¥: %w", id, err)
        }
    }

    return nil
}
```

**å…³é”®ç‚¹**ï¼š
- `defer` ç¡®ä¿äº‹åŠ¡ä¸€å®šä¼šè¢«å¤„ç†ï¼ˆæäº¤æˆ–å›æ»šï¼‰
- ä½¿ç”¨å‘½åè¿”å›å€¼ `err` è®© defer èƒ½è®¿é—®åˆ°é”™è¯¯
- æ¯æ­¥æ“ä½œéƒ½æ£€æŸ¥é”™è¯¯

---

## ğŸ’» å®æˆ˜ï¼šå®ç°ç®€å•çš„æ‰¹é‡æ“ä½œ

### éœ€æ±‚æè¿°

å®ç°ä¸¤ä¸ªæ‰¹é‡æ“ä½œåŠŸèƒ½ï¼š
1. **æ‰¹é‡å®Œæˆ**ï¼šå°†å¤šä¸ªå¾…åŠäº‹é¡¹æ ‡è®°ä¸ºå·²å®Œæˆ
2. **æ‰¹é‡åˆ é™¤**ï¼šåˆ é™¤å¤šä¸ªå¾…åŠäº‹é¡¹

**è¦æ±‚**ï¼š
- ä½¿ç”¨äº‹åŠ¡ä¿è¯åŸå­æ€§
- å…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥
- é™åˆ¶æ‰¹é‡å¤§å°ï¼ˆæœ€å¤š100ä¸ªï¼‰

### æ­¥éª¤ 1ï¼šæ•°æ®åº“å±‚å®ç°

åœ¨ `database/db.go` æ–‡ä»¶æœ«å°¾æ·»åŠ ä»¥ä¸‹æ–¹æ³•ï¼š

```go
// BatchCompleteTodosContext æ‰¹é‡å®Œæˆå¾…åŠäº‹é¡¹ï¼ˆå…¨æœ‰æˆ–å…¨æ— ï¼‰
func (db *DB) BatchCompleteTodosContext(ctx context.Context, ids []int) error {
    // éªŒè¯è¾“å…¥
    if len(ids) == 0 {
        return nil  // ç©ºåˆ—è¡¨ç›´æ¥è¿”å›æˆåŠŸ
    }

    if len(ids) > 100 {
        return fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ100ä¸ªé¡¹ç›®ï¼Œå½“å‰: %d", len(ids))
    }

    // å¼€å¯äº‹åŠ¡ï¼ˆä½¿ç”¨ BeginTx æ”¯æŒ Contextï¼‰
    tx, err := db.conn.BeginTx(ctx, nil)
    if err != nil {
        return fmt.Errorf("å¼€å¯äº‹åŠ¡å¤±è´¥: %w", err)
    }

    // ä½¿ç”¨ defer ç¡®ä¿äº‹åŠ¡è¢«å¤„ç†
    defer func() {
        if err != nil {
            // å›æ»šæ—¶ä¹Ÿè®°å½•é”™è¯¯
            if rbErr := tx.Rollback(); rbErr != nil {
                log.Printf("å›æ»šå¤±è´¥: %v (åŸå§‹é”™è¯¯: %v)", rbErr, err)
            }
        }
    }()

    // æ‰¹é‡æ›´æ–°
    now := time.Now().UTC()
    for _, id := range ids {
        // æ£€æŸ¥ Context æ˜¯å¦å·²å–æ¶ˆ
        select {
        case <-ctx.Done():
            return ctx.Err()
        default:
        }

        result, err := tx.ExecContext(ctx, `
            UPDATE todos
            SET status = 'completed',
                completed_at = ?,
                updated_at = ?
            WHERE id = ? AND status = 'pending'
        `, now, now, id)

        if err != nil {
            return fmt.Errorf("æ›´æ–° ID %d å¤±è´¥: %w", id, err)
        }

        // æ£€æŸ¥æ˜¯å¦çœŸçš„æ›´æ–°äº†
        rows, err := result.RowsAffected()
        if err != nil {
            return fmt.Errorf("è·å–å½±å“è¡Œæ•°å¤±è´¥: %w", err)
        }

        if rows == 0 {
            return fmt.Errorf("å¾…åŠäº‹é¡¹ %d ä¸å­˜åœ¨æˆ–å·²å®Œæˆ", id)
        }
    }

    // æäº¤äº‹åŠ¡
    if err = tx.Commit(); err != nil {
        return fmt.Errorf("æäº¤äº‹åŠ¡å¤±è´¥: %w", err)
    }

    return nil
}

// BatchDeleteTodosContext æ‰¹é‡åˆ é™¤å¾…åŠäº‹é¡¹ï¼ˆå…¨æœ‰æˆ–å…¨æ— ï¼‰
func (db *DB) BatchDeleteTodosContext(ctx context.Context, ids []int) error {
    // éªŒè¯è¾“å…¥
    if len(ids) == 0 {
        return nil
    }

    if len(ids) > 100 {
        return fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ100ä¸ªé¡¹ç›®ï¼Œå½“å‰: %d", len(ids))
    }

    // å¼€å¯äº‹åŠ¡ï¼ˆä½¿ç”¨ BeginTx æ”¯æŒ Contextï¼‰
    tx, err := db.conn.BeginTx(ctx, nil)
    if err != nil {
        return fmt.Errorf("å¼€å¯äº‹åŠ¡å¤±è´¥: %w", err)
    }

    // ä½¿ç”¨ defer ç¡®ä¿äº‹åŠ¡è¢«å¤„ç†
    defer func() {
        if err != nil {
            if rbErr := tx.Rollback(); rbErr != nil {
                log.Printf("å›æ»šå¤±è´¥: %v (åŸå§‹é”™è¯¯: %v)", rbErr, err)
            }
        }
    }()

    // æ‰¹é‡åˆ é™¤
    for _, id := range ids {
        // æ£€æŸ¥ Context æ˜¯å¦å·²å–æ¶ˆ
        select {
        case <-ctx.Done():
            return ctx.Err()
        default:
        }

        result, err := tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)

        if err != nil {
            return fmt.Errorf("åˆ é™¤ ID %d å¤±è´¥: %w", id, err)
        }

        // æ£€æŸ¥æ˜¯å¦çœŸçš„åˆ é™¤äº†
        rows, err := result.RowsAffected()
        if err != nil {
            return fmt.Errorf("è·å–å½±å“è¡Œæ•°å¤±è´¥: %w", err)
        }

        if rows == 0 {
            return fmt.Errorf("å¾…åŠäº‹é¡¹ %d ä¸å­˜åœ¨", id)
        }
    }

    // æäº¤äº‹åŠ¡
    if err = tx.Commit(); err != nil {
        return fmt.Errorf("æäº¤äº‹åŠ¡å¤±è´¥: %w", err)
    }

    return nil
}
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… ä½¿ç”¨ `BeginTx(ctx, nil)` è€Œä¸æ˜¯ `Begin()` - æ”¯æŒè¶…æ—¶å’Œå–æ¶ˆ
- âœ… åœ¨å¾ªç¯ä¸­æ£€æŸ¥ `ctx.Done()` - å…è®¸é•¿æ—¶é—´æ“ä½œè¢«ä¸­æ–­
- âœ… è®°å½• `Rollback()` å¤±è´¥ - ä¾¿äºæ’æŸ¥é—®é¢˜
- âœ… ä½¿ç”¨ `ExecContext` - è®©æ•°æ®åº“é©±åŠ¨æ„ŸçŸ¥è¶…æ—¶

**ä¸ºä»€ä¹ˆéœ€è¦ Contextï¼Ÿ**
- é˜²æ­¢æ‰¹é‡æ“ä½œå¡ä½ï¼ˆè¶…æ—¶è‡ªåŠ¨ä¸­æ–­ï¼‰
- ç”¨æˆ·å–æ¶ˆè¯·æ±‚æ—¶ç«‹å³åœæ­¢ï¼ˆèŠ‚çœèµ„æºï¼‰
- ç»Ÿä¸€çš„è¶…æ—¶ç®¡ç†ï¼ˆHandler å±‚è®¾ç½®è¶…æ—¶æ—¶é—´ï¼‰

### æ­¥éª¤ 2ï¼šå¤„ç†å™¨å±‚å®ç°

**ç¬¬ 1 æ­¥**ï¼šåœ¨ `handler/handler.go` çš„è¶…æ—¶é…ç½®å¸¸é‡ä¸­æ·»åŠ ï¼ˆçº¦åœ¨ç¬¬ 52-59 è¡Œï¼‰ï¼š

```go
const (
    DefaultTimeout = 10 * time.Second // é»˜è®¤è¶…æ—¶
    ListTimeout    = 5 * time.Second  // åˆ—è¡¨æŸ¥è¯¢è¶…æ—¶
    CreateTimeout  = 3 * time.Second  // åˆ›å»ºè¶…æ—¶
    UpdateTimeout  = 3 * time.Second  // æ›´æ–°è¶…æ—¶
    DeleteTimeout  = 2 * time.Second  // åˆ é™¤è¶…æ—¶
    StatsTimeout   = 5 * time.Second  // ç»Ÿè®¡æŸ¥è¯¢è¶…æ—¶
    BatchTimeout   = 10 * time.Second // æ‰¹é‡æ“ä½œè¶…æ—¶ï¼ˆæ–°å¢ï¼‰
)
```

**ç¬¬ 2 æ­¥**ï¼šæ·»åŠ  BatchRequest ç»“æ„ä½“å’Œå¤„ç†å™¨æ–¹æ³•ï¼š

```go
// BatchRequest æ‰¹é‡æ“ä½œè¯·æ±‚
type BatchRequest struct {
    IDs []int `json:"ids"`
}

// BatchCompleteTodos æ‰¹é‡å®Œæˆå¾…åŠäº‹é¡¹
func (h *Handler) BatchCompleteTodos(w http.ResponseWriter, r *http.Request) {
    // åˆ›å»ºå¸¦è¶…æ—¶çš„ Context
    ctx, cancel := context.WithTimeout(r.Context(), BatchTimeout)
    defer cancel()

    defer r.Body.Close()

    var req BatchRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        h.sendError(w, http.StatusBadRequest, "INVALID_JSON", "è¯·æ±‚æ ¼å¼é”™è¯¯")
        return
    }

    // éªŒè¯è¯·æ±‚
    if len(req.IDs) == 0 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", "IDsä¸èƒ½ä¸ºç©º")
        return
    }

    // æ‰§è¡Œæ‰¹é‡æ“ä½œ
    if err := h.db.BatchCompleteTodosContext(ctx, req.IDs); err != nil {
        // åŒºåˆ†è¶…æ—¶é”™è¯¯å’Œå…¶ä»–é”™è¯¯
        if errors.Is(err, context.DeadlineExceeded) {
            log.Printf("BatchComplete timeout: %v", err)
            h.sendError(w, http.StatusRequestTimeout, "TIMEOUT", "æ‰¹é‡æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
            return
        }
        if errors.Is(err, context.Canceled) {
            log.Printf("BatchComplete canceled: %v", err)
            return  // å®¢æˆ·ç«¯å–æ¶ˆï¼Œä¸å“åº”
        }
        log.Printf("æ‰¹é‡å®Œæˆå¤±è´¥: %v", err)
        h.sendError(w, http.StatusInternalServerError, "BATCH_ERROR", err.Error())
        return
    }

    h.sendJSON(w, http.StatusOK, Response{
        Success: true,
        Message: fmt.Sprintf("æˆåŠŸå®Œæˆ %d ä¸ªå¾…åŠäº‹é¡¹", len(req.IDs)),
    })
}

// BatchDeleteTodos æ‰¹é‡åˆ é™¤å¾…åŠäº‹é¡¹
func (h *Handler) BatchDeleteTodos(w http.ResponseWriter, r *http.Request) {
    // åˆ›å»ºå¸¦è¶…æ—¶çš„ Context
    ctx, cancel := context.WithTimeout(r.Context(), BatchTimeout)
    defer cancel()

    defer r.Body.Close()

    var req BatchRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        h.sendError(w, http.StatusBadRequest, "INVALID_JSON", "è¯·æ±‚æ ¼å¼é”™è¯¯")
        return
    }

    // éªŒè¯è¯·æ±‚
    if len(req.IDs) == 0 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", "IDsä¸èƒ½ä¸ºç©º")
        return
    }

    // æ‰§è¡Œæ‰¹é‡æ“ä½œ
    if err := h.db.BatchDeleteTodosContext(ctx, req.IDs); err != nil {
        // åŒºåˆ†è¶…æ—¶é”™è¯¯å’Œå…¶ä»–é”™è¯¯
        if errors.Is(err, context.DeadlineExceeded) {
            log.Printf("BatchDelete timeout: %v", err)
            h.sendError(w, http.StatusRequestTimeout, "TIMEOUT", "æ‰¹é‡æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
            return
        }
        if errors.Is(err, context.Canceled) {
            log.Printf("BatchDelete canceled: %v", err)
            return  // å®¢æˆ·ç«¯å–æ¶ˆï¼Œä¸å“åº”
        }
        log.Printf("æ‰¹é‡åˆ é™¤å¤±è´¥: %v", err)
        h.sendError(w, http.StatusInternalServerError, "BATCH_ERROR", err.Error())
        return
    }

    h.sendJSON(w, http.StatusOK, Response{
        Success: true,
        Message: fmt.Sprintf("æˆåŠŸåˆ é™¤ %d ä¸ªå¾…åŠäº‹é¡¹", len(req.IDs)),
    })
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… ä½¿ç”¨ `context.WithTimeout` åˆ›å»ºè¶…æ—¶æ§åˆ¶
- âœ… åŒºåˆ†ä¸‰ç§é”™è¯¯ï¼šè¶…æ—¶ï¼ˆ408ï¼‰ã€å–æ¶ˆï¼ˆä¸å“åº”ï¼‰ã€å…¶ä»–ï¼ˆ500ï¼‰
- âœ… éµå¾ªé¡¹ç›®ç°æœ‰çš„é”™è¯¯å¤„ç†æ¨¡å¼ï¼ˆå‚è€ƒ `ListTodos` ç­‰æ–¹æ³•ï¼‰

### æ­¥éª¤ 3ï¼šæ³¨å†Œè·¯ç”±

åœ¨ `api/routes.go` çš„ `registerTodoRoutes` é—­åŒ…å‡½æ•°ä¸­æ·»åŠ æ‰¹é‡æ“ä½œè·¯ç”±ï¼ˆçº¦åœ¨ç¬¬ 58-68 è¡Œï¼‰ï¼š

```go
registerTodoRoutes := func(base string) {
    mux.HandleFunc("GET "+base, withMiddlewares(h.ListTodos))
    mux.HandleFunc("POST "+base, withMiddlewares(h.CreateTodo))
    mux.HandleFunc("OPTIONS "+base, withMiddlewares(optionsHandler))

    mux.HandleFunc("GET "+base+"/stats", withMiddlewares(h.GetStats))

    // âš ï¸ æ‰¹é‡æ“ä½œè·¯ç”±å¿…é¡»åœ¨ /{id} ä¹‹å‰æ³¨å†Œ
    mux.HandleFunc("POST "+base+"/batch/complete", withMiddlewares(h.BatchCompleteTodos))
    mux.HandleFunc("POST "+base+"/batch/delete", withMiddlewares(h.BatchDeleteTodos))

    mux.HandleFunc("PUT "+base+"/{id}", withMiddlewares(h.UpdateTodo))
    mux.HandleFunc("DELETE "+base+"/{id}", withMiddlewares(h.DeleteTodo))
    mux.HandleFunc("OPTIONS "+base+"/{id}", withMiddlewares(optionsHandler))
}
```

**ä¸ºä»€ä¹ˆé¡ºåºé‡è¦ï¼Ÿ**
- Go 1.22+ çš„è·¯ç”±åŒ¹é…å™¨ä¼šæŒ‰æ³¨å†Œé¡ºåºåŒ¹é…
- `/batch/complete` å¿…é¡»åœ¨ `/{id}` å‰æ³¨å†Œï¼Œå¦åˆ™ "batch" ä¼šè¢«å½“ä½œ ID åŒ¹é…

---

## ğŸ”’ æ‰¹é‡æ“ä½œä¸­çš„ä¹è§‚é”è€ƒè™‘

**é—®é¢˜**ï¼šé¡¹ç›®ä½¿ç”¨ä¹è§‚é”ï¼ˆversion å­—æ®µï¼‰ï¼Œæ‰¹é‡æ“ä½œå¦‚ä½•å¤„ç†ï¼Ÿ

### åœºæ™¯ 1ï¼šæ‰¹é‡å®Œæˆ - ä¸æ£€æŸ¥ version âœ…

**ç†ç”±**ï¼š
- æ‰¹é‡å®Œæˆé€šå¸¸æ˜¯ç®¡ç†æ“ä½œï¼Œä¸éœ€è¦ä¸¥æ ¼çš„å¹¶å‘æ§åˆ¶
- åªæ›´æ–° `status = 'pending'` çš„è®°å½•ï¼Œå·²å®Œæˆçš„ä¼šè¢« `RowsAffected = 0` æ‹¦æˆª
- ç®€å•ä¸”é«˜æ•ˆ

**å®ç°**ï¼š
```go
WHERE id = ? AND status = 'pending'  // ä¸æ£€æŸ¥ version
```

### åœºæ™¯ 2ï¼šæ‰¹é‡åˆ é™¤ - ä¸æ£€æŸ¥ version âœ…

**ç†ç”±**ï¼š
- åˆ é™¤æ“ä½œå¤©ç„¶å¹‚ç­‰ï¼ˆåˆ äº†å°±æ²¡äº†ï¼‰
- å³ä½¿å¹¶å‘åˆ é™¤ï¼Œç»“æœä¹Ÿæ˜¯ä¸€è‡´çš„
- ä¸éœ€è¦ç‰ˆæœ¬æ§åˆ¶

**å®ç°**ï¼š
```go
DELETE FROM todos WHERE id = ?  // ä¸æ£€æŸ¥ version
```

### åœºæ™¯ 3ï¼šå¦‚æœéœ€è¦æ£€æŸ¥ versionï¼Ÿâš ï¸

**ä½•æ—¶éœ€è¦**ï¼š
- æ‰¹é‡æ›´æ–°å¤æ‚å­—æ®µï¼ˆå¦‚ title, descriptionï¼‰
- éœ€è¦ä¿è¯"çœ‹åˆ°çš„æ•°æ®"å’Œ"ä¿®æ”¹çš„æ•°æ®"ä¸€è‡´

**å®ç°æ–¹å¼**ï¼š
```go
type BatchUpdateRequest struct {
    Items []struct {
        ID      int    `json:"id"`
        Version int    `json:"version"`
        Title   string `json:"title"`
    } `json:"items"`
}

// åœ¨äº‹åŠ¡ä¸­é€ä¸ªæ£€æŸ¥ version
WHERE id = ? AND version = ?
```

**æƒè¡¡**ï¼š
- âœ… ä¿è¯å¼ºä¸€è‡´æ€§
- âŒ å¢åŠ å®ç°å¤æ‚åº¦
- âŒ ä»»ä¸€ç‰ˆæœ¬å†²çªå¯¼è‡´å…¨éƒ¨å›æ»š

**æ¨èç­–ç•¥**ï¼š
1. **ç®€å•æ‰¹é‡æ“ä½œ**ï¼ˆå¦‚æ‰¹é‡å®Œæˆã€åˆ é™¤ï¼‰ï¼šä¸æ£€æŸ¥ version
2. **å¤æ‚æ‰¹é‡æ›´æ–°**ï¼ˆå¦‚ä¿®æ”¹å†…å®¹ï¼‰ï¼šè€ƒè™‘ä½¿ç”¨å•ä¸ªæ›´æ–° APIï¼ˆä¿ç•™ä¹è§‚é”ï¼‰
3. **çœŸæ­£éœ€è¦æ‰¹é‡æ›´æ–°å¤æ‚å­—æ®µ**ï¼šä¸‹ä¸€èŠ‚æ•™ç¨‹ï¼ˆæ•™å­¦-6-æ‰¹é‡æ“ä½œè¿›é˜¶.mdï¼‰

---

## âš ï¸ å¸¸è§é™·é˜±

### 1. å¿˜è®°å¤„ç†äº‹åŠ¡

**é”™è¯¯ä»£ç **ï¼š
```go
tx, _ := db.Begin()
tx.Exec("DELETE FROM todos WHERE id = 1")
// å¿˜è®° Commitï¼Œäº‹åŠ¡ä¼šè‡ªåŠ¨å›æ»šï¼
```

**æ­£ç¡®ä»£ç **ï¼š
```go
tx, _ := db.Begin()
defer func() {
    if err != nil {
        tx.Rollback()
    } else {
        tx.Commit()
    }
}()
tx.Exec("DELETE FROM todos WHERE id = 1")
```

### 2. Commit åç»§ç»­ä½¿ç”¨äº‹åŠ¡

**é”™è¯¯ä»£ç **ï¼š
```go
tx.Commit()
tx.Exec("DELETE...")  // âŒ é”™è¯¯ï¼šäº‹åŠ¡å·²ç»“æŸ
```

### 3. ä¸æ£€æŸ¥ RowsAffected

**é—®é¢˜**ï¼š
```go
tx.Exec("DELETE FROM todos WHERE id = 999")  // IDä¸å­˜åœ¨
// æ²¡æœ‰é”™è¯¯ï¼Œä½†ä¹Ÿæ²¡æœ‰åˆ é™¤ä»»ä½•ä¸œè¥¿
```

**è§£å†³**ï¼š
```go
result, _ := tx.Exec("DELETE FROM todos WHERE id = 999")
if rows, _ := result.RowsAffected(); rows == 0 {
    return fmt.Errorf("è®°å½•ä¸å­˜åœ¨")
}
```

### 4. å¿˜è®°ä½¿ç”¨ Context âš ï¸

**é”™è¯¯ä»£ç **ï¼š
```go
tx, _ := db.conn.Begin()  // âŒ æ— æ³•è¶…æ—¶æ§åˆ¶
tx.Exec("DELETE...")      // âŒ é©±åŠ¨æ„ŸçŸ¥ä¸åˆ°è¶…æ—¶
```

**æ­£ç¡®ä»£ç **ï¼š
```go
tx, _ := db.conn.BeginTx(ctx, nil)  // âœ… æ”¯æŒè¶…æ—¶
tx.ExecContext(ctx, "DELETE...")    // âœ… é©±åŠ¨å¯ä»¥ä¸­æ–­
```

**ä¸ºä»€ä¹ˆé‡è¦**ï¼š
- æ‰¹é‡æ“ä½œå¯èƒ½å¾ˆè€—æ—¶ï¼Œå¿…é¡»æœ‰è¶…æ—¶ä¿æŠ¤
- Context å–æ¶ˆæ—¶ï¼Œæ•°æ®åº“é©±åŠ¨å¯ä»¥ç«‹å³åœæ­¢æ‰§è¡Œ

### 5. Context æ£€æŸ¥ä½ç½®ä¸å½“ âš ï¸

**ä½æ•ˆä»£ç **ï¼š
```go
for _, id := range ids {
    // å¾ªç¯å†…ä¸æ£€æŸ¥ Contextï¼Œæ— æ³•åŠæ—¶ä¸­æ–­
    tx.ExecContext(ctx, "DELETE...", id)
}
```

**é«˜æ•ˆä»£ç **ï¼š
```go
for _, id := range ids {
    // æ¯æ¬¡å¾ªç¯å‰æ£€æŸ¥ï¼Œå¿«é€Ÿå“åº”å–æ¶ˆ
    select {
    case <-ctx.Done():
        return ctx.Err()
    default:
    }
    tx.ExecContext(ctx, "DELETE...", id)
}
```

**æƒè¡¡**ï¼š
- âœ… å¿«é€Ÿå“åº”ç”¨æˆ·å–æ¶ˆï¼ˆ< 100msï¼‰
- âŒ æ¯æ¬¡å¾ªç¯å¢åŠ å¾®å°å¼€é”€ï¼ˆ~100nsï¼Œå¯å¿½ç•¥ï¼‰

---

## ğŸ§ª æµ‹è¯•ä½ çš„å®ç°

### æ–¹å¼ 1ï¼šä½¿ç”¨ç°æœ‰æµ‹è¯•å·¥å…·ï¼ˆæ¨èï¼‰

é¡¹ç›®å·²æœ‰å®Œæ•´çš„ API æµ‹è¯•å·¥å…·ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

```bash
# å¯åŠ¨æœåŠ¡å™¨
go run cmd/server/main.go

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯è¿è¡Œæµ‹è¯•
go run scripts/api-test/main.go
```

**ä¼˜ç‚¹**ï¼š
- âœ… è‡ªåŠ¨éªŒè¯å“åº”æ ¼å¼å’ŒçŠ¶æ€ç 
- âœ… è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
- âœ… å¯ä»¥ä½œä¸ºé›†æˆæµ‹è¯•çš„ä¸€éƒ¨åˆ†

### æ–¹å¼ 2ï¼šæ‰‹åŠ¨æµ‹è¯•ï¼ˆå¿«é€ŸéªŒè¯ï¼‰

ä½¿ç”¨ `curl` å¿«é€ŸéªŒè¯åŠŸèƒ½ï¼š

```bash
BASE_URL="http://localhost:7789/api/v1/todos"

# 1. åˆ›å»ºæµ‹è¯•æ•°æ®
curl -X POST "$BASE_URL" -H "Content-Type: application/json" \
  -d '{"title": "ä»»åŠ¡1"}'
curl -X POST "$BASE_URL" -H "Content-Type: application/json" \
  -d '{"title": "ä»»åŠ¡2"}'
curl -X POST "$BASE_URL" -H "Content-Type: application/json" \
  -d '{"title": "ä»»åŠ¡3"}'

# 2. æµ‹è¯•æ‰¹é‡å®Œæˆ
curl -X POST "$BASE_URL/batch/complete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 2]}'

# 3. æµ‹è¯•æ‰¹é‡åˆ é™¤
curl -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [3]}'

# 4. æµ‹è¯•é”™è¯¯æƒ…å†µï¼ˆä¸å­˜åœ¨çš„IDï¼‰
curl -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [999]}'
```

### æ–¹å¼ 3ï¼šç¼–å†™ä¸“é—¨çš„æ‰¹é‡æµ‹è¯•ï¼ˆå­¦ä¹ ç›®æ ‡ï¼‰

å‚è€ƒ `scripts/api-test/main.go` çš„æ¨¡å¼ï¼Œç¼–å†™ä¸“é—¨çš„æ‰¹é‡æ“ä½œæµ‹è¯•ï¼š

```go
// scripts/batch-test/main.go
package main

import (
    "bytes"
    "encoding/json"
    "fmt"
    "net/http"
)

func testBatchComplete() {
    // åˆ›å»º3ä¸ªå¾…åŠäº‹é¡¹
    ids := []int{}
    for i := 1; i <= 3; i++ {
        // åˆ›å»ºé€»è¾‘...
        ids = append(ids, id)
    }

    // æ‰¹é‡å®Œæˆ
    reqBody, _ := json.Marshal(map[string][]int{"ids": ids})
    resp, _ := http.Post(
        "http://localhost:7789/api/v1/todos/batch/complete",
        "application/json",
        bytes.NewBuffer(reqBody),
    )

    // éªŒè¯ç»“æœ...
}
```

### é¢„æœŸç»“æœ

1. **æ‰¹é‡å®ŒæˆæˆåŠŸ**ï¼š
   ```json
   {
     "success": true,
     "message": "æˆåŠŸå®Œæˆ 2 ä¸ªå¾…åŠäº‹é¡¹"
   }
   ```

2. **æ‰¹é‡åˆ é™¤æˆåŠŸ**ï¼š
   ```json
   {
     "success": true,
     "message": "æˆåŠŸåˆ é™¤ 1 ä¸ªå¾…åŠäº‹é¡¹"
   }
   ```

3. **é”™è¯¯æƒ…å†µï¼ˆä¸å­˜åœ¨çš„IDï¼‰**ï¼š
   ```json
   {
     "success": false,
     "error": {
       "code": "BATCH_ERROR",
       "message": "å¾…åŠäº‹é¡¹ 999 ä¸å­˜åœ¨"
     }
   }
   ```

4. **è¶…æ—¶æµ‹è¯•**ï¼š
   - æ‰¹é‡æ“ä½œ > 100 ä¸ª ID æˆ–é•¿æ—¶é—´è¿è¡Œ
   - åº”è¿”å› 408 çŠ¶æ€ç å’Œ "TIMEOUT" é”™è¯¯

---

## âœ… å®ç°æ£€æŸ¥æ¸…å•

å®Œæˆå®ç°åï¼Œç¡®è®¤ä»¥ä¸‹å†…å®¹ï¼š

**åŠŸèƒ½**ï¼š
- [ ] æ‰¹é‡å®ŒæˆåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ‰¹é‡åˆ é™¤åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] ç©ºåˆ—è¡¨å¤„ç†æ­£ç¡®ï¼ˆè¿”å›æˆåŠŸï¼‰
- [ ] è¶…è¿‡100ä¸ªIDæ—¶æ‹’ç»æ“ä½œ
- [ ] IDä¸å­˜åœ¨æ—¶äº‹åŠ¡å›æ»š
- [ ] è¶…æ—¶æƒ…å†µè¿”å›æ­£ç¡®çš„é”™è¯¯ç ï¼ˆ408ï¼‰

**ä»£ç è´¨é‡**ï¼š
- [ ] ä½¿ç”¨ `BeginTx(ctx, nil)` è€Œä¸æ˜¯ `Begin()`
- [ ] ä½¿ç”¨ `ExecContext(ctx, ...)` è€Œä¸æ˜¯ `Exec(...)`
- [ ] ä½¿ç”¨ defer ç¡®ä¿äº‹åŠ¡å¤„ç†
- [ ] è®°å½• `Rollback()` å¤±è´¥çš„æƒ…å†µ
- [ ] æ¯æ­¥æ“ä½œéƒ½æ£€æŸ¥é”™è¯¯
- [ ] æ£€æŸ¥ `RowsAffected`
- [ ] æœ‰åˆç†çš„é”™è¯¯ä¿¡æ¯
- [ ] åœ¨å¾ªç¯ä¸­æ£€æŸ¥ `ctx.Done()`ï¼ˆå…è®¸ä¸­æ–­ï¼‰

**é”™è¯¯å¤„ç†**ï¼ˆHandler å±‚ï¼‰ï¼š
- [ ] åŒºåˆ†è¶…æ—¶é”™è¯¯ï¼ˆ`context.DeadlineExceeded`ï¼‰
- [ ] åŒºåˆ†å–æ¶ˆé”™è¯¯ï¼ˆ`context.Canceled`ï¼‰
- [ ] åŒºåˆ†å…¶ä»–æ•°æ®åº“é”™è¯¯
- [ ] è¶…æ—¶æ—¶è¿”å› 408 çŠ¶æ€ç 
- [ ] å–æ¶ˆæ—¶ä¸è¿”å›å“åº”

**å®‰å…¨æ€§**ï¼š
- [ ] ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆé˜²SQLæ³¨å…¥ï¼‰
- [ ] æœ‰æ‰¹é‡å¤§å°é™åˆ¶
- [ ] æœ‰è¶…æ—¶ä¿æŠ¤ï¼ˆHandler å±‚è®¾ç½®è¶…æ—¶ï¼‰
- [ ] Context è¶…æ—¶æ—¶æ•°æ®åº“æ“ä½œå¯ä»¥è¢«ä¸­æ–­

---

## ğŸ“– æ‰©å±•å­¦ä¹ 

å­¦å®ŒåŸºç¡€äº‹åŠ¡åï¼Œå¯ä»¥äº†è§£ï¼š

1. **äº‹åŠ¡éš”ç¦»çº§åˆ«**
   - READ UNCOMMITTED
   - READ COMMITTED
   - REPEATABLE READ
   - SERIALIZABLE

2. **åˆ†å¸ƒå¼äº‹åŠ¡**
   - ä¸¤é˜¶æ®µæäº¤ï¼ˆ2PCï¼‰
   - ä¸‰é˜¶æ®µæäº¤ï¼ˆ3PCï¼‰
   - Sagaæ¨¡å¼

3. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡æ’å…¥ä¼˜åŒ–
   - äº‹åŠ¡å¤§å°æƒè¡¡
   - é”ç«äº‰å¤„ç†

---

## ğŸ¯ ä¸‹ä¸€æ­¥

å®Œæˆæœ¬èŠ‚åï¼Œä½ åº”è¯¥ï¼š
1. ç†è§£äº‹åŠ¡çš„ACIDç‰¹æ€§
2. æŒæ¡Goä¸­çš„äº‹åŠ¡ä½¿ç”¨
3. èƒ½å®ç°ç®€å•çš„æ‰¹é‡æ“ä½œ

**ä¸‹ä¸€èŠ‚**ï¼šå¦‚æœéœ€è¦æ›´å¤æ‚çš„æ‰¹é‡æ“ä½œï¼ˆéƒ¨åˆ†å¤±è´¥å¤„ç†ï¼‰ï¼Œå‚è€ƒ `æ•™å­¦-5b-æ‰¹é‡æ“ä½œè¿›é˜¶.md`

---

## ğŸ’¡ è®°ä½

> "Simplicity is the ultimate sophistication." - Leonardo da Vinci

ä»ç®€å•çš„"å…¨æœ‰æˆ–å…¨æ— "å¼€å§‹ï¼Œè¿™å·²ç»èƒ½è§£å†³90%çš„æ‰¹é‡æ“ä½œéœ€æ±‚ã€‚åªæœ‰åœ¨çœŸæ­£éœ€è¦æ—¶æ‰å¢åŠ å¤æ‚æ€§ã€‚

**ç°åœ¨ï¼Œå¼€å§‹åŠ¨æ‰‹å®ç°å§ï¼** ğŸš€