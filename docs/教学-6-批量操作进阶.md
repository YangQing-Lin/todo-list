# æ•™å­¦ Part 6: æ‰¹é‡æ“ä½œè¿›é˜¶ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰

> **ğŸ“Œ å­¦ä¹ é˜¶æ®µ**: ä¸­çº§è¿›é˜¶ / Go æ•°æ®åº“ç¼–ç¨‹
> **å‰ç½®è¦æ±‚**: å·²å®Œæˆæ•™å­¦-5ï¼ˆäº‹åŠ¡åŸºç¡€ + å…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼‰
> **å­¦ä¹ ç›®æ ‡**: å®ç°éƒ¨åˆ†æˆåŠŸç­–ç•¥çš„æ‰¹é‡æ“ä½œï¼Œç†è§£ä¸¤ç§ç­–ç•¥çš„æƒè¡¡
> **æ—¶é—´æŠ•å…¥**: 2-3 å°æ—¶

---

## ğŸ¯ åŠŸèƒ½åˆ†æ - Linus å¼æ€è€ƒ

### Linus çš„ä¸‰ä¸ªé—®é¢˜

**1. "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„ï¼Ÿ"**

âœ… **çœŸå®é—®é¢˜**ï¼š
- ç”¨æˆ·éœ€è¦åˆ é™¤ 20 ä¸ªå·²å®Œæˆçš„å¾…åŠäº‹é¡¹ï¼Œç°åœ¨è¦ç‚¹å‡» 20 æ¬¡"åˆ é™¤"æŒ‰é’®
- ç”¨æˆ·æƒ³æ‰¹é‡å®Œæˆä¸€ç»„ç›¸å…³çš„ä»»åŠ¡ï¼ˆå¦‚"æœ¬å‘¨çš„æ‰€æœ‰ä¼šè®®å‡†å¤‡ä»»åŠ¡"ï¼‰ï¼Œé€ä¸ªç‚¹å‡»æ•ˆç‡å¤ªä½
- å‰ç«¯å‘é€ 20 ä¸ªè¯·æ±‚ = 20 æ¬¡ç½‘ç»œå¾€è¿” = æ…¢ä¸”æµªè´¹å¸¦å®½

**ä¸ºä»€ä¹ˆéœ€è¦æ‰¹é‡æ“ä½œï¼Ÿ**
- **ç”¨æˆ·ä½“éªŒ**ï¼šä¸€æ¬¡æ“ä½œå®Œæˆå¤šä¸ªä»»åŠ¡
- **æ€§èƒ½ä¼˜åŒ–**ï¼šå‡å°‘ç½‘ç»œå¾€è¿”ï¼ˆ20 æ¬¡ â†’ 1 æ¬¡ï¼‰
- **æ•°æ®ä¸€è‡´æ€§**ï¼šè¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥ï¼ˆä½¿ç”¨äº‹åŠ¡ï¼‰

**2. "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—ï¼Ÿ"**

ğŸ’¡ **æ ¸å¿ƒæ€è·¯**ï¼šæ•°æ®åº“äº‹åŠ¡ + å¾ªç¯å¤„ç†

**ç¬¨æ–¹æ³•**ï¼ˆå‰ç«¯å¾ªç¯è°ƒç”¨ï¼‰ï¼š
```javascript
// âŒ ä½æ•ˆï¼š20 ä¸ªå¾…åŠ = 20 æ¬¡ç½‘ç»œè¯·æ±‚
for (const id of selectedIds) {
    await fetch(`/api/v1/todos/${id}`, { method: 'DELETE' });
}
// é—®é¢˜ï¼šæŸä¸ªåˆ é™¤å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿæ•°æ®ä¸ä¸€è‡´ï¼
```

**èªæ˜æ–¹æ³•**ï¼ˆåç«¯æ‰¹é‡å¤„ç† + äº‹åŠ¡ï¼‰ï¼š
```go
// âœ… é«˜æ•ˆï¼š1 æ¬¡è¯·æ±‚ï¼Œäº‹åŠ¡ä¿è¯åŸå­æ€§
func BatchDelete(ids []int) error {
    tx.Begin()
    for _, id := range ids {
        tx.Exec("DELETE FROM todos WHERE id = ?", id)
    }
    tx.Commit()  // è¦ä¹ˆå…¨åˆ é™¤ï¼Œè¦ä¹ˆå…¨ä¸åˆ é™¤
}
```

**3. "ä¼šç ´åä»€ä¹ˆå—ï¼Ÿ"**

âš ï¸ **æ½œåœ¨é£é™©**ï¼š
- æ‰¹é‡æ“ä½œä¸­æŸä¸ª ID ä¸å­˜åœ¨ â†’ æ˜¯æ•´ä½“å¤±è´¥è¿˜æ˜¯è·³è¿‡ï¼Ÿ
- äº‹åŠ¡é”å®šè¡¨ â†’ æ‰¹é‡ 1000 ä¸ª ID ä¼šä¸ä¼šé”å¤ªä¹…ï¼Ÿ
- æ¶æ„è¯·æ±‚ â†’ ä¼ å…¥ 10000 ä¸ª ID ä¼šä¸ä¼šæ‹–å®æ•°æ®åº“ï¼Ÿ

âœ… **å®‰å…¨è®¾è®¡**ï¼š
- **éƒ¨åˆ†å¤±è´¥ç­–ç•¥**ï¼šè®°å½•å¤±è´¥çš„ IDï¼Œè¿”å›ç»™å‰ç«¯
- **æ‰¹é‡å¤§å°é™åˆ¶**ï¼šæœ€å¤š 100 ä¸ª ID/æ¬¡ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰
- **äº‹åŠ¡è¶…æ—¶**ï¼šSQLite é»˜è®¤æœ‰é”è¶…æ—¶ï¼ˆ5 ç§’ï¼‰
- **å‘åå…¼å®¹**ï¼šæ–°å¢ç‹¬ç«‹ç«¯ç‚¹ï¼Œä¸å½±å“ç°æœ‰å•ä¸ªæ“ä½œ API

---

## ğŸ“š æ ¸å¿ƒçŸ¥è¯†è®²è§£

### 1. æ•°æ®åº“äº‹åŠ¡çš„ ACID ç‰¹æ€§

**ACID** æ˜¯æ•°æ®åº“äº‹åŠ¡çš„å››å¤§ä¿è¯ï¼š

**A - Atomicityï¼ˆåŸå­æ€§ï¼‰**
```go
// è¦ä¹ˆå…¨æˆåŠŸï¼Œè¦ä¹ˆå…¨å¤±è´¥
tx.Begin()
tx.Exec("DELETE FROM todos WHERE id = 1")  // âœ… æˆåŠŸ
tx.Exec("DELETE FROM todos WHERE id = 2")  // âŒ å¤±è´¥ï¼ˆä¸å­˜åœ¨ï¼‰
tx.Rollback()  // å›æ»šï¼Œid=1 çš„åˆ é™¤ä¹Ÿè¢«æ’¤é”€
```

**C - Consistencyï¼ˆä¸€è‡´æ€§ï¼‰**
```go
// æ•°æ®åº“çº¦æŸå§‹ç»ˆè¢«æ»¡è¶³
tx.Begin()
tx.Exec("UPDATE todos SET status = 'invalid'")  // âŒ è¿åçº¦æŸ
tx.Commit()  // å¤±è´¥ï¼Œæ•°æ®åº“æ‹’ç»æäº¤
```

**I - Isolationï¼ˆéš”ç¦»æ€§ï¼‰**
```go
// ä¸¤ä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œï¼Œäº’ä¸å½±å“
// äº‹åŠ¡ A è¯»å– id=1 â†’ çœ‹åˆ°æ—§å€¼
// äº‹åŠ¡ B ä¿®æ”¹ id=1 â†’ æœªæäº¤
// äº‹åŠ¡ A å†æ¬¡è¯»å– id=1 â†’ ä»ç„¶æ˜¯æ—§å€¼ï¼ˆéš”ç¦»ï¼‰
```

**D - Durabilityï¼ˆæŒä¹…æ€§ï¼‰**
```go
// æäº¤åï¼Œæ•°æ®æ°¸ä¹…ä¿å­˜ï¼ˆå³ä½¿æ–­ç”µï¼‰
tx.Commit()  // âœ… æˆåŠŸ
// æ­¤æ—¶æœåŠ¡å™¨å´©æºƒ â†’ æ•°æ®ä»ç„¶åœ¨ç£ç›˜ä¸Š
```

---

### 2. Go ä¸­çš„äº‹åŠ¡ä½¿ç”¨æ¨¡å¼

**æ ‡å‡†æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼š

```go
func BatchOperation(db *sql.DB, ids []int) error {
    // 1. å¼€å¯äº‹åŠ¡
    tx, err := db.Begin()
    if err != nil {
        return fmt.Errorf("failed to begin transaction: %w", err)
    }

    // 2. ç¡®ä¿å›æ»šï¼ˆå¦‚æœå‡ºé”™ï¼‰
    defer func() {
        if err != nil {
            tx.Rollback()
        }
    }()

    // 3. æ‰§è¡Œæ“ä½œï¼ˆæ¯æ­¥æ£€æŸ¥é”™è¯¯ï¼‰
    for _, id := range ids {
        _, err = tx.Exec("DELETE FROM todos WHERE id = ?", id)
        if err != nil {
            return fmt.Errorf("failed to delete id %d: %w", id, err)
        }
    }

    // 4. æäº¤äº‹åŠ¡
    if err = tx.Commit(); err != nil {
        return fmt.Errorf("failed to commit transaction: %w", err)
    }

    return nil
}
```

**å…³é”®ç‚¹**ï¼š
- `defer tx.Rollback()` ç¡®ä¿å‡ºé”™æ—¶è‡ªåŠ¨å›æ»š
- æ¯ä¸ª `tx.Exec` éƒ½æ£€æŸ¥é”™è¯¯
- `tx.Commit()` çš„è¿”å›å€¼ä¹Ÿè¦æ£€æŸ¥

---

### 3. æ‰¹é‡æ“ä½œçš„é”™è¯¯å¤„ç†ç­–ç•¥

**ç­–ç•¥ Aï¼šå…¨æœ‰æˆ–å…¨æ— ï¼ˆAll-or-Nothingï¼‰**

```go
// ä¸€ä¸ªå¤±è´¥ â†’ å…¨éƒ¨å›æ»š
for _, id := range ids {
    _, err = tx.Exec("DELETE FROM todos WHERE id = ?", id)
    if err != nil {
        return err  // è§¦å‘ defer å›æ»š
    }
}
```

**ä¼˜ç‚¹**ï¼šç®€å•ã€æ•°æ®ä¸€è‡´æ€§å¼º
**ç¼ºç‚¹**ï¼š1 ä¸ªå ID å¯¼è‡´ 99 ä¸ªå¥½ ID ä¹Ÿæ— æ³•å¤„ç†

---

**ç­–ç•¥ Bï¼šéƒ¨åˆ†æˆåŠŸï¼ˆBest-Effortï¼‰**

```go
// è®°å½•å¤±è´¥çš„ IDï¼Œç»§ç»­å¤„ç†å…¶ä»–
var failures []BatchError
for _, id := range ids {
    _, err = tx.Exec("DELETE FROM todos WHERE id = ?", id)
    if err != nil {
        failures = append(failures, BatchError{ID: id, Error: err.Error()})
    }
}

if len(failures) > 0 {
    // æäº¤æˆåŠŸçš„ï¼Œè¿”å›å¤±è´¥åˆ—è¡¨
    tx.Commit()
    return &PartialError{Failures: failures}
}
```

**ä¼˜ç‚¹**ï¼šå®¹é”™æ€§å¥½ï¼Œç”¨æˆ·ä½“éªŒå‹å¥½
**ç¼ºç‚¹**ï¼šå¤æ‚åº¦æ›´é«˜ï¼Œéœ€è¦é¢å¤–çš„é”™è¯¯ç»“æ„

---

**æœ¬é¡¹ç›®æ¨è**ï¼šç­–ç•¥ Bï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰

**åŸå› **ï¼š
- ç”¨æˆ·é€‰æ‹©äº† 20 ä¸ª IDï¼Œå…¶ä¸­ 1 ä¸ªå·²è¢«å…¶ä»–äººåˆ é™¤
- ç­–ç•¥ A ä¼šå¯¼è‡´å…¨éƒ¨å¤±è´¥ï¼ˆç”¨æˆ·å›°æƒ‘ï¼š"ä¸ºä»€ä¹ˆä¸€ä¸ªéƒ½æ²¡åˆ æ‰ï¼Ÿ"ï¼‰
- ç­–ç•¥ B ä¼šåˆ é™¤ 19 ä¸ªï¼Œå‘Šè¯‰ç”¨æˆ·"1 ä¸ªå¤±è´¥äº†"ï¼ˆç”¨æˆ·å¯ä»¥æ¥å—ï¼‰

---

### 4. SQLite çš„äº‹åŠ¡é”æœºåˆ¶

**SQLite çš„é”çº§åˆ«**ï¼ˆä»ä½åˆ°é«˜ï¼‰ï¼š

1. **UNLOCKED** - æ— é”
2. **SHARED** - å…±äº«é”ï¼ˆå¤šä¸ªè¯»å–è€…ï¼‰
3. **RESERVED** - é¢„ç•™é”ï¼ˆå‡†å¤‡å†™å…¥ï¼‰
4. **PENDING** - å¾…å®šé”ï¼ˆç­‰å¾…å…¶ä»–è¯»å–è€…ç»“æŸï¼‰
5. **EXCLUSIVE** - æ’ä»–é”ï¼ˆæ‰§è¡Œå†™å…¥ï¼‰

**äº‹åŠ¡é”çš„æ¼”è¿›**ï¼š

```go
tx.Begin()          // UNLOCKED â†’ RESERVEDï¼ˆé¢„ç•™ï¼‰
tx.Exec("SELECT")   // RESERVED â†’ SHAREDï¼ˆè¯»å–ï¼‰
tx.Exec("UPDATE")   // SHARED â†’ EXCLUSIVEï¼ˆå†™å…¥ï¼Œé˜»å¡å…¶ä»–æ‰€æœ‰æ“ä½œï¼‰
tx.Commit()         // EXCLUSIVE â†’ UNLOCKEDï¼ˆé‡Šæ”¾é”ï¼‰
```

**æ‰¹é‡æ“ä½œçš„é”å½±å“**ï¼š

```go
// æ‰¹é‡åˆ é™¤ 100 ä¸ªå¾…åŠ
tx.Begin()  // è·å– RESERVED é”
for i := 1; i <= 100; i++ {
    tx.Exec("DELETE FROM todos WHERE id = ?", i)  // è·å– EXCLUSIVE é”
}
// åœ¨è¿™æ®µæ—¶é—´å†…ï¼Œå…¶ä»–è¿æ¥ï¼š
// - æ— æ³•è¯»å–ï¼ˆSHARED é”è¢«é˜»å¡ï¼‰
// - æ— æ³•å†™å…¥ï¼ˆEXCLUSIVE é”è¢«é˜»å¡ï¼‰
tx.Commit()  // é‡Šæ”¾é”
```

**æ€§èƒ½è€ƒè™‘**ï¼š
- SQLite æ˜¯æ–‡ä»¶é”ï¼Œç²’åº¦è¾ƒç²—ï¼ˆä¸åƒ PostgreSQL æœ‰è¡Œçº§é”ï¼‰
- æ‰¹é‡æ“ä½œæ—¶é—´è¶Šé•¿ï¼Œé˜»å¡å…¶ä»–è¯·æ±‚çš„æ—¶é—´è¶Šé•¿
- **æ¨è**ï¼šæ‰¹é‡å¤§å°é™åˆ¶åœ¨ 100 ä»¥å†…ï¼ˆå¤„ç†æ—¶é—´ < 100msï¼‰

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

### æ–‡ä»¶ 1: `database/db.go` - æ–°å¢æ‰¹é‡æ“ä½œå‡½æ•°

> **æ³¨æ„**ï¼šæœ¬èŠ‚æ˜¯æ•™å­¦-5ï¼ˆå…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼‰çš„è¿›é˜¶ç‰ˆæœ¬ï¼Œå®ç°**éƒ¨åˆ†æˆåŠŸç­–ç•¥**ã€‚
> å‡½æ•°å‘½åå¸¦ `Context` åç¼€ï¼Œä¸é¡¹ç›®ç°æœ‰ä»£ç é£æ ¼ä¿æŒä¸€è‡´ã€‚

```go
package database

import (
	"context"
	"fmt"
	"log"
	"time"
)

// BatchError æ‰¹é‡æ“ä½œä¸­çš„å•ä¸ªé”™è¯¯
type BatchError struct {
	ID    int    `json:"id"`
	Error string `json:"error"`
}

// BatchResult æ‰¹é‡æ“ä½œç»“æœ
type BatchResult struct {
	SuccessCount int          `json:"success_count"`
	FailedCount  int          `json:"failed_count"`
	Errors       []BatchError `json:"errors,omitempty"`
}

// BatchCompleteTodosPartialContext æ‰¹é‡å®Œæˆå¾…åŠäº‹é¡¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰
// ä¸æ•™å­¦-5çš„ BatchCompleteTodosContextï¼ˆå…¨æœ‰æˆ–å…¨æ— ï¼‰ä¸åŒï¼Œ
// æœ¬æ–¹æ³•å…è®¸éƒ¨åˆ†æˆåŠŸï¼Œè®°å½•å¤±è´¥çš„ ID å¹¶è¿”å›ç»™è°ƒç”¨è€…ã€‚
func (db *DB) BatchCompleteTodosPartialContext(ctx context.Context, ids []int) (*BatchResult, error) {
	if len(ids) == 0 {
		return &BatchResult{}, nil
	}

	// é™åˆ¶æ‰¹é‡å¤§å°
	if len(ids) > 100 {
		return nil, fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(ids))
	}

	// ä½¿ç”¨ BeginTx æ”¯æŒ Contextï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰
	tx, err := db.conn.BeginTx(ctx, nil)
	if err != nil {
		return nil, fmt.Errorf("failed to begin transaction: %w", err)
	}

	defer func() {
		if err != nil {
			if rbErr := tx.Rollback(); rbErr != nil {
				log.Printf("å›æ»šå¤±è´¥: %v (åŸå§‹é”™è¯¯: %v)", rbErr, err)
			}
		}
	}()

	result := &BatchResult{
		Errors: make([]BatchError, 0),
	}

	for _, id := range ids {
		// æ£€æŸ¥ Context æ˜¯å¦å·²å–æ¶ˆï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰
		select {
		case <-ctx.Done():
			return nil, ctx.Err()
		default:
		}

		// åœ¨ Go å±‚ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç»Ÿä¸€ä½¿ç”¨ UTCï¼‰
		now := time.Now().UTC()

		res, execErr := tx.ExecContext(ctx, `
			UPDATE todos
			SET status = 'completed',
			    completed_at = ?,
			    updated_at = ?
			WHERE id = ? AND status = 'pending'
		`, now, now, id)

		if execErr != nil {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: execErr.Error(),
			})
			continue
		}

		// æ£€æŸ¥æ˜¯å¦çœŸçš„æ›´æ–°äº†ï¼ˆå¯èƒ½ ID ä¸å­˜åœ¨æˆ–å·²ç» completedï¼‰
		rowsAffected, rowErr := res.RowsAffected()
		if rowErr != nil {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: fmt.Sprintf("è·å–å—å½±å“è¡Œæ•°å¤±è´¥: %v", rowErr),
			})
			continue
		}
		if rowsAffected == 0 {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: "å¾…åŠäº‹é¡¹ä¸å­˜åœ¨æˆ–å·²å®Œæˆ",
			})
		} else {
			result.SuccessCount++
		}
	}

	// æäº¤äº‹åŠ¡ï¼ˆå³ä½¿æœ‰éƒ¨åˆ†å¤±è´¥ï¼ŒæˆåŠŸçš„ä¹Ÿè¦æäº¤ï¼‰
	if err = tx.Commit(); err != nil {
		return nil, fmt.Errorf("failed to commit transaction: %w", err)
	}

	return result, nil
}

// BatchDeleteTodosPartialContext æ‰¹é‡åˆ é™¤å¾…åŠäº‹é¡¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰
func (db *DB) BatchDeleteTodosPartialContext(ctx context.Context, ids []int) (*BatchResult, error) {
	if len(ids) == 0 {
		return &BatchResult{}, nil
	}

	// é™åˆ¶æ‰¹é‡å¤§å°
	if len(ids) > 100 {
		return nil, fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(ids))
	}

	// ä½¿ç”¨ BeginTx æ”¯æŒ Context
	tx, err := db.conn.BeginTx(ctx, nil)
	if err != nil {
		return nil, fmt.Errorf("failed to begin transaction: %w", err)
	}

	defer func() {
		if err != nil {
			if rbErr := tx.Rollback(); rbErr != nil {
				log.Printf("å›æ»šå¤±è´¥: %v (åŸå§‹é”™è¯¯: %v)", rbErr, err)
			}
		}
	}()

	result := &BatchResult{
		Errors: make([]BatchError, 0),
	}

	for _, id := range ids {
		// æ£€æŸ¥ Context æ˜¯å¦å·²å–æ¶ˆ
		select {
		case <-ctx.Done():
			return nil, ctx.Err()
		default:
		}

		res, execErr := tx.ExecContext(ctx, `DELETE FROM todos WHERE id = ?`, id)

		if execErr != nil {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: execErr.Error(),
			})
			continue
		}

		// æ£€æŸ¥æ˜¯å¦çœŸçš„åˆ é™¤äº†
		rowsAffected, rowErr := res.RowsAffected()
		if rowErr != nil {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: fmt.Sprintf("è·å–å—å½±å“è¡Œæ•°å¤±è´¥: %v", rowErr),
			})
			continue
		}
		if rowsAffected == 0 {
			result.FailedCount++
			result.Errors = append(result.Errors, BatchError{
				ID:    id,
				Error: "å¾…åŠäº‹é¡¹ä¸å­˜åœ¨",
			})
		} else {
			result.SuccessCount++
		}
	}

	// æäº¤äº‹åŠ¡
	if err = tx.Commit(); err != nil {
		return nil, fmt.Errorf("failed to commit transaction: %w", err)
	}

	return result, nil
}
```

---

### å…³é”®ç‚¹è§£æ

**1. Context æ”¯æŒ**ï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰
```go
// ä½¿ç”¨ BeginTx æ”¯æŒ Context
tx, err := db.conn.BeginTx(ctx, nil)

// åœ¨å¾ªç¯ä¸­æ£€æŸ¥ Context æ˜¯å¦å–æ¶ˆ
select {
case <-ctx.Done():
    return nil, ctx.Err()
default:
}

// ä½¿ç”¨ ExecContext è€Œé Exec
res, execErr := tx.ExecContext(ctx, ...)
```
- æ”¯æŒè¶…æ—¶æ§åˆ¶å’Œè¯·æ±‚å–æ¶ˆ
- ä¸é¡¹ç›®ç°æœ‰ä»£ç é£æ ¼ä¸€è‡´

**2. æ‰¹é‡å¤§å°é™åˆ¶**
```go
if len(ids) > 100 {
    return nil, fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(ids))
}
```
- é˜²æ­¢æ¶æ„è¯·æ±‚ï¼ˆä¼ å…¥ 10000 ä¸ª IDï¼‰
- æ§åˆ¶äº‹åŠ¡é”å®šæ—¶é—´ï¼ˆ< 100msï¼‰
- æé«˜ç”¨æˆ·ä½“éªŒï¼ˆå‰ç«¯å¯ä»¥æç¤º"è¯·åˆ†æ‰¹é€‰æ‹©"ï¼‰

**3. ç©ºåˆ—è¡¨å¤„ç†**
```go
if len(ids) == 0 {
    return &BatchResult{}, nil
}
```
- é¿å…ç©ºäº‹åŠ¡
- è¿”å›æˆåŠŸç»“æœï¼ˆSuccessCount=0, FailedCount=0ï¼‰

**4. éƒ¨åˆ†å¤±è´¥ç­–ç•¥**ï¼ˆä¸æ•™å­¦-5çš„å…¨æœ‰æˆ–å…¨æ— ç­–ç•¥å¯¹æ¯”ï¼‰
```go
for _, id := range ids {
    res, execErr := tx.ExecContext(ctx, ...)
    if execErr != nil {
        result.FailedCount++
        result.Errors = append(result.Errors, BatchError{...})
        continue  // å…³é”®ï¼šç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªï¼Œè€Œéç«‹å³è¿”å›
    }

    rowsAffected, _ := res.RowsAffected()
    if rowsAffected == 0 {
        result.FailedCount++
        result.Errors = append(result.Errors, ...)
    } else {
        result.SuccessCount++
    }
}
```
- ä½¿ç”¨ `continue` è·³è¿‡å¤±è´¥çš„ IDï¼ˆæ•™å­¦-5 ä½¿ç”¨ `return`ï¼‰
- è®°å½•æ¯ä¸ªå¤±è´¥çš„åŸå› 
- æ£€æŸ¥ `RowsAffected`ï¼ˆåŒºåˆ†"æ‰§è¡Œå¤±è´¥"å’Œ"ID ä¸å­˜åœ¨"ï¼‰

**5. äº‹åŠ¡æäº¤**
```go
// æäº¤äº‹åŠ¡ï¼ˆå³ä½¿æœ‰éƒ¨åˆ†å¤±è´¥ï¼ŒæˆåŠŸçš„ä¹Ÿè¦æäº¤ï¼‰
if err = tx.Commit(); err != nil {
    return nil, fmt.Errorf("failed to commit transaction: %w", err)
}
```
- å³ä½¿æœ‰å¤±è´¥ï¼ŒæˆåŠŸçš„ä¹Ÿè¦æäº¤
- å¦‚æœ `Commit` å¤±è´¥ï¼ˆç£ç›˜æ»¡ç­‰ï¼‰ï¼Œè¿”å›é”™è¯¯

**6. æ‰¹é‡å®Œæˆçš„ç‰¹æ®Šé€»è¾‘**
```go
// åœ¨ Go å±‚ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç»Ÿä¸€ä½¿ç”¨ UTCï¼‰
now := time.Now().UTC()

UPDATE todos
SET status = 'completed',
    completed_at = ?,  // ä½¿ç”¨ Go ç”Ÿæˆçš„æ—¶é—´æˆ³
    updated_at = ?
WHERE id = ? AND status = 'pending'
```
- åœ¨ Go å±‚ç”Ÿæˆæ—¶é—´æˆ³è€Œä¸æ˜¯ä½¿ç”¨ SQL å‡½æ•°
- ç»Ÿä¸€ä½¿ç”¨ `time.Now().UTC()` ä¿è¯æ—¶åŒºä¸€è‡´æ€§
- `WHERE status = 'pending'` é¿å…é‡å¤å®Œæˆ
- ä¸é¡¹ç›®ä¸­å…¶ä»–æ—¶é—´å­—æ®µçš„å¤„ç†æ–¹å¼ä¿æŒä¸€è‡´

---

### æ–‡ä»¶ 2: `handler/handler.go` - æ–°å¢æ‰¹é‡æ“ä½œ handlers

> **æ³¨æ„**ï¼šHandler ä»£ç ä¸æ•™å­¦-5ä¿æŒä¸€è‡´çš„ Context è¶…æ—¶æ§åˆ¶æ¨¡å¼ã€‚
> ä½¿ç”¨é¡¹ç›®å·²æœ‰çš„ `BatchTimeout` å¸¸é‡ï¼ˆåœ¨æ•™å­¦-5ä¸­æ·»åŠ ï¼‰ã€‚

**ç¬¬ 1 æ­¥**ï¼šç¡®ä¿ `handler/handler.go` å·²æœ‰ `BatchTimeout` å¸¸é‡ï¼ˆæ•™å­¦-5å·²æ·»åŠ ï¼‰ï¼š
```go
const (
    DefaultTimeout = 10 * time.Second // é»˜è®¤è¶…æ—¶
    ListTimeout    = 5 * time.Second  // åˆ—è¡¨æŸ¥è¯¢è¶…æ—¶
    CreateTimeout  = 3 * time.Second  // åˆ›å»ºè¶…æ—¶
    UpdateTimeout  = 3 * time.Second  // æ›´æ–°è¶…æ—¶
    DeleteTimeout  = 2 * time.Second  // åˆ é™¤è¶…æ—¶
    StatsTimeout   = 5 * time.Second  // ç»Ÿè®¡æŸ¥è¯¢è¶…æ—¶
    BatchTimeout   = 10 * time.Second // æ‰¹é‡æ“ä½œè¶…æ—¶
)
```

**ç¬¬ 2 æ­¥**ï¼šæ·»åŠ æ‰¹é‡æ“ä½œ handlersï¼ˆä½¿ç”¨éƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰ï¼š

```go
// BatchRequest æ‰¹é‡æ“ä½œè¯·æ±‚ï¼ˆå¤ç”¨æ•™å­¦-5çš„ç»“æ„ä½“ï¼‰
// å¦‚æœæ•™å­¦-5æœªæ·»åŠ ï¼Œéœ€è¦åœ¨æ­¤æ·»åŠ 
type BatchRequest struct {
    IDs []int `json:"ids"`
}

// BatchCompleteTodosPartial æ‰¹é‡å®Œæˆå¾…åŠäº‹é¡¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰
func (h *Handler) BatchCompleteTodosPartial(w http.ResponseWriter, r *http.Request) {
    // åˆ›å»ºå¸¦è¶…æ—¶çš„ Contextï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰
    ctx, cancel := context.WithTimeout(r.Context(), BatchTimeout)
    defer cancel()

    defer r.Body.Close()

    var req BatchRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        h.sendError(w, http.StatusBadRequest, "INVALID_JSON", fmt.Sprintf("JSON è§£æå¤±è´¥: %v", err))
        return
    }

    // éªŒè¯è¯·æ±‚
    if len(req.IDs) == 0 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", "IDs ä¸èƒ½ä¸ºç©º")
        return
    }

    // æ‰¹é‡å¤§å°é™åˆ¶ï¼ˆHandler å±‚ä¹Ÿåšæ ¡éªŒï¼ŒåŒé‡ä¿æŠ¤ï¼‰
    if len(req.IDs) > 100 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", fmt.Sprintf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(req.IDs)))
        return
    }

    // æ‰§è¡Œæ‰¹é‡æ“ä½œï¼ˆä½¿ç”¨éƒ¨åˆ†æˆåŠŸç­–ç•¥çš„å‡½æ•°ï¼‰
    result, err := h.db.BatchCompleteTodosPartialContext(ctx, req.IDs)
    if err != nil {
        // åŒºåˆ†è¶…æ—¶é”™è¯¯å’Œå…¶ä»–é”™è¯¯ï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰
        if errors.Is(err, context.DeadlineExceeded) {
            log.Printf("BatchCompletePartial timeout: %v", err)
            h.sendError(w, http.StatusRequestTimeout, "TIMEOUT", "æ‰¹é‡æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
            return
        }
        if errors.Is(err, context.Canceled) {
            log.Printf("BatchCompletePartial canceled: %v", err)
            return // å®¢æˆ·ç«¯å–æ¶ˆï¼Œä¸å“åº”
        }
        log.Printf("Failed to batch complete todos: %v", err)
        h.sendError(w, http.StatusInternalServerError, "BATCH_OPERATION_ERROR", err.Error())
        return
    }

    response := Response{
        Success: true,
        Data:    result,
        Message: "æ‰¹é‡å®Œæˆæ“ä½œå®Œæˆ",
    }
    h.sendJSON(w, http.StatusOK, response)
}

// BatchDeleteTodosPartial æ‰¹é‡åˆ é™¤å¾…åŠäº‹é¡¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰
func (h *Handler) BatchDeleteTodosPartial(w http.ResponseWriter, r *http.Request) {
    // åˆ›å»ºå¸¦è¶…æ—¶çš„ Context
    ctx, cancel := context.WithTimeout(r.Context(), BatchTimeout)
    defer cancel()

    defer r.Body.Close()

    var req BatchRequest
    if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
        h.sendError(w, http.StatusBadRequest, "INVALID_JSON", fmt.Sprintf("JSON è§£æå¤±è´¥: %v", err))
        return
    }

    // éªŒè¯è¯·æ±‚
    if len(req.IDs) == 0 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", "IDs ä¸èƒ½ä¸ºç©º")
        return
    }

    // æ‰¹é‡å¤§å°é™åˆ¶
    if len(req.IDs) > 100 {
        h.sendError(w, http.StatusBadRequest, "VALIDATION_ERROR", fmt.Sprintf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(req.IDs)))
        return
    }

    // æ‰§è¡Œæ‰¹é‡æ“ä½œ
    result, err := h.db.BatchDeleteTodosPartialContext(ctx, req.IDs)
    if err != nil {
        if errors.Is(err, context.DeadlineExceeded) {
            log.Printf("BatchDeletePartial timeout: %v", err)
            h.sendError(w, http.StatusRequestTimeout, "TIMEOUT", "æ‰¹é‡æ“ä½œè¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•")
            return
        }
        if errors.Is(err, context.Canceled) {
            log.Printf("BatchDeletePartial canceled: %v", err)
            return
        }
        log.Printf("Failed to batch delete todos: %v", err)
        h.sendError(w, http.StatusInternalServerError, "BATCH_OPERATION_ERROR", err.Error())
        return
    }

    response := Response{
        Success: true,
        Data:    result,
        Message: "æ‰¹é‡åˆ é™¤æ“ä½œå®Œæˆ",
    }
    h.sendJSON(w, http.StatusOK, response)
}
```

---

### æ–‡ä»¶ 3: `api/routes.go` - æ³¨å†Œæ‰¹é‡æ“ä½œè·¯ç”±

> **æ³¨æ„**ï¼šæ•™å­¦-5å·²æ·»åŠ åŸºç¡€æ‰¹é‡æ“ä½œè·¯ç”±ï¼ˆå…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼‰ã€‚
> æœ¬èŠ‚æ·»åŠ éƒ¨åˆ†æˆåŠŸç­–ç•¥çš„è·¯ç”±ï¼ˆä½¿ç”¨ä¸åŒç«¯ç‚¹åŒºåˆ†ï¼‰ã€‚

**é€‰é¡¹ A**ï¼šæ›¿æ¢åŸæœ‰ç«¯ç‚¹ï¼ˆå¦‚æœåªéœ€è¦éƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰

```go
registerTodoRoutes := func(base string) {
    mux.HandleFunc("GET "+base, withMiddlewares(h.ListTodos))
    mux.HandleFunc("POST "+base, withMiddlewares(h.CreateTodo))
    mux.HandleFunc("OPTIONS "+base, withMiddlewares(optionsHandler))

    mux.HandleFunc("GET "+base+"/stats", withMiddlewares(h.GetStats))

    // æ‰¹é‡æ“ä½œç«¯ç‚¹ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼Œæ›¿æ¢æ•™å­¦-5çš„å…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼‰
    mux.HandleFunc("POST "+base+"/batch/complete", withMiddlewares(h.BatchCompleteTodosPartial))
    mux.HandleFunc("POST "+base+"/batch/delete", withMiddlewares(h.BatchDeleteTodosPartial))
    mux.HandleFunc("OPTIONS "+base+"/batch/complete", withMiddlewares(optionsHandler))
    mux.HandleFunc("OPTIONS "+base+"/batch/delete", withMiddlewares(optionsHandler))

    mux.HandleFunc("PUT "+base+"/{id}", withMiddlewares(h.UpdateTodo))
    mux.HandleFunc("DELETE "+base+"/{id}", withMiddlewares(h.DeleteTodo))
    mux.HandleFunc("OPTIONS "+base+"/{id}", withMiddlewares(optionsHandler))
}
```

**é€‰é¡¹ B**ï¼šåŒæ—¶ä¿ç•™ä¸¤ç§ç­–ç•¥ï¼ˆä½¿ç”¨ä¸åŒç«¯ç‚¹ï¼‰

```go
registerTodoRoutes := func(base string) {
    mux.HandleFunc("GET "+base, withMiddlewares(h.ListTodos))
    mux.HandleFunc("POST "+base, withMiddlewares(h.CreateTodo))
    mux.HandleFunc("OPTIONS "+base, withMiddlewares(optionsHandler))

    mux.HandleFunc("GET "+base+"/stats", withMiddlewares(h.GetStats))

    // æ•™å­¦-5ï¼šå…¨æœ‰æˆ–å…¨æ— ç­–ç•¥
    mux.HandleFunc("POST "+base+"/batch/complete", withMiddlewares(h.BatchCompleteTodos))
    mux.HandleFunc("POST "+base+"/batch/delete", withMiddlewares(h.BatchDeleteTodos))

    // æ•™å­¦-6ï¼šéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼ˆæ–°ç«¯ç‚¹ï¼‰
    mux.HandleFunc("POST "+base+"/batch/complete-partial", withMiddlewares(h.BatchCompleteTodosPartial))
    mux.HandleFunc("POST "+base+"/batch/delete-partial", withMiddlewares(h.BatchDeleteTodosPartial))

    // OPTIONS å¤„ç†
    mux.HandleFunc("OPTIONS "+base+"/batch/complete", withMiddlewares(optionsHandler))
    mux.HandleFunc("OPTIONS "+base+"/batch/delete", withMiddlewares(optionsHandler))
    mux.HandleFunc("OPTIONS "+base+"/batch/complete-partial", withMiddlewares(optionsHandler))
    mux.HandleFunc("OPTIONS "+base+"/batch/delete-partial", withMiddlewares(optionsHandler))

    mux.HandleFunc("PUT "+base+"/{id}", withMiddlewares(h.UpdateTodo))
    mux.HandleFunc("DELETE "+base+"/{id}", withMiddlewares(h.DeleteTodo))
    mux.HandleFunc("OPTIONS "+base+"/{id}", withMiddlewares(optionsHandler))
}
```

**è·¯ç”±æ³¨å†Œé¡ºåºï¼ˆæœ€ä½³å®è·µï¼‰**ï¼š
- æ‰¹é‡æ“ä½œç«¯ç‚¹å¿…é¡»åœ¨ `/{id}` ä¹‹å‰æ³¨å†Œ
- Go 1.22+ ä¼šè‡ªåŠ¨é€‰æ‹©æ›´å…·ä½“çš„æ¨¡å¼ï¼ˆ`/batch/complete` æ¯” `/{id}` æ›´å…·ä½“ï¼‰
- ä½†ä¸ºäº†ä»£ç å¯è¯»æ€§ï¼Œå»ºè®®æŒ‰"ä»å…·ä½“åˆ°é€šç”¨"çš„é¡ºåºæ³¨å†Œ
- å‚è€ƒå½“å‰é¡¹ç›®çš„ `api/routes.go:58-68` çš„æ³¨å†Œé¡ºåº

---

## âš ï¸ æ½œåœ¨é™·é˜±å’Œæœ€ä½³å®è·µ

### 1. **äº‹åŠ¡ä¸­çš„æŸ¥è¯¢æ€§èƒ½é™·é˜±**

**é—®é¢˜ä»£ç **ï¼š
```go
// âŒ æ¯æ¬¡å¾ªç¯éƒ½æŸ¥è¯¢ä¸€æ¬¡æ•°æ®åº“
for _, id := range ids {
    var todo model.Todo
    tx.QueryRowContext(ctx, "SELECT * FROM todos WHERE id = ?", id).Scan(&todo)
    if todo.Status == "pending" {
        tx.ExecContext(ctx, "UPDATE todos SET status = 'completed' WHERE id = ?", id)
    }
}
```

**é—®é¢˜**ï¼š
- 100 ä¸ª ID = 100 æ¬¡ SELECT + 100 æ¬¡ UPDATE = 200 æ¬¡æ•°æ®åº“æ“ä½œ
- äº‹åŠ¡é”å®šæ—¶é—´è¿‡é•¿

**æ­£ç¡®ä»£ç **ï¼š
```go
// âœ… ä½¿ç”¨ WHERE æ¡ä»¶è¿‡æ»¤ï¼Œå‡å°‘æŸ¥è¯¢
for _, id := range ids {
    tx.ExecContext(ctx, "UPDATE todos SET status = 'completed' WHERE id = ? AND status = 'pending'", id)
}
```

---

### 2. **RowsAffected çš„é‡è¦æ€§**

**åœºæ™¯**ï¼šç”¨æˆ·é€‰æ‹©äº† ID [1, 2, 3] è¿›è¡Œæ‰¹é‡åˆ é™¤ï¼Œä½† ID=2 ä¸å­˜åœ¨

**ä¸æ£€æŸ¥ RowsAffected**ï¼š
```go
// âŒ æ— æ³•åŒºåˆ†"åˆ é™¤æˆåŠŸ"å’Œ"ID ä¸å­˜åœ¨"
for _, id := range ids {
    tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
    result.SuccessCount++  // é”™è¯¯ï¼ID=2 ä¸å­˜åœ¨ï¼Œä½†ä»ç„¶è®¡æ•°ä¸ºæˆåŠŸ
}
// è¿”å›ï¼šSuccessCount=3, FailedCount=0ï¼ˆç”¨æˆ·ä»¥ä¸ºå…¨éƒ¨åˆ é™¤äº†ï¼‰
```

**æ£€æŸ¥ RowsAffected**ï¼š
```go
// âœ… æ­£ç¡®åŒºåˆ†
for _, id := range ids {
    res, _ := tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
    rows, _ := res.RowsAffected()
    if rows == 0 {
        result.FailedCount++
        result.Errors = append(result.Errors, BatchError{ID: id, Error: "ä¸å­˜åœ¨"})
    } else {
        result.SuccessCount++
    }
}
// è¿”å›ï¼šSuccessCount=2, FailedCount=1, Errors=[{ID:2, Error:"ä¸å­˜åœ¨"}]
```

---

### 3. **äº‹åŠ¡å›æ»šçš„é™·é˜±**

**é—®é¢˜åœºæ™¯**ï¼š
```go
tx, _ := db.conn.BeginTx(ctx, nil)
for _, id := range ids {
    _, err := tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
    if err != nil {
        tx.Rollback()  // âŒ ç«‹å³å›æ»šï¼Œåé¢çš„ä»£ç è¿˜ä¼šç»§ç»­æ‰§è¡Œï¼
        return err
    }
}
tx.Commit()  // âš ï¸ å¦‚æœå‰é¢ Rollback äº†ï¼Œè¿™é‡Œä¼šå‡ºé”™
```

**é—®é¢˜**ï¼š
- `Rollback()` åï¼Œ`tx` å·²å¤±æ•ˆ
- åç»­çš„ `Commit()` ä¼šè¿”å› `sql.ErrTxDone` é”™è¯¯

**æ­£ç¡®ä»£ç **ï¼š
```go
// ä½¿ç”¨å‘½åè¿”å›å€¼ï¼Œè®© defer èƒ½è®¿é—®åˆ°çœŸæ­£çš„é”™è¯¯
func BatchDelete(ctx context.Context, ids []int) (err error) {
    tx, err := db.conn.BeginTx(ctx, nil)
    if err != nil {
        return err
    }

    defer func() {
        if err != nil {
            if rbErr := tx.Rollback(); rbErr != nil {
                log.Printf("å›æ»šå¤±è´¥: %v", rbErr)
            }
        }
    }()

    for _, id := range ids {
        _, err = tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
        if err != nil {
            return err  // è§¦å‘ defer å›æ»š
        }
    }

    if err = tx.Commit(); err != nil {
        return err
    }
    return nil
}
```

---

### 4. **å˜é‡é®è”½å¯¼è‡´ defer å¤±æ•ˆ** âš ï¸

> **è¯¦ç»†è§£é‡Šè§æ•™å­¦-5çš„"å¸¸è§é™·é˜±"ç¬¬6æ¡ã€‚**

**ç®€è¿°**ï¼šåœ¨å¾ªç¯ä¸­ä½¿ç”¨ `:=` å£°æ˜ `err` ä¼šåˆ›å»ºæ–°å˜é‡ï¼Œé®è”½å¤–å±‚çš„ `err`ï¼Œå¯¼è‡´ defer ä¸­çš„å›æ»šé€»è¾‘æ°¸è¿œä¸ä¼šæ‰§è¡Œã€‚

**é”™è¯¯ä»£ç **ï¼š
```go
for _, id := range ids {
    result, err := tx.ExecContext(ctx, ...)  // âŒ := åˆ›å»ºæ–°å˜é‡
    rows, err := result.RowsAffected()       // âŒ åŒæ ·é®è”½
}
```

**æ­£ç¡®åšæ³•**ï¼š
1. ä½¿ç”¨å‘½åè¿”å›å€¼ `(err error)`
2. é¢„å…ˆå£°æ˜å˜é‡ `var result sql.Result`
3. å¾ªç¯å†…ä½¿ç”¨ `=` èµ‹å€¼

**æœ¬èŠ‚ç¤ºä¾‹ä¸ºä½•æ²¡é—®é¢˜ï¼Ÿ**

æœ¬èŠ‚çš„ `BatchCompleteTodosPartialContext` ä½¿ç”¨äº†ä¸åŒçš„å˜é‡åï¼š
```go
res, execErr := tx.ExecContext(ctx, ...)  // âœ… ç”¨ execErrï¼Œä¸é®è”½ err
rowsAffected, rowErr := res.RowsAffected()  // âœ… ç”¨ rowErr
```

è¿™æ˜¯å¦ä¸€ç§é¿å…é®è”½çš„æ–¹å¼ï¼šä½¿ç”¨ä¸åŒçš„å˜é‡åã€‚

---

### 5. **SQL æ³¨å…¥çš„é£é™©**

**é—®é¢˜ä»£ç **ï¼š
```go
// âŒ æ‹¼æ¥ SQLï¼Œå­˜åœ¨æ³¨å…¥é£é™©
query := fmt.Sprintf("DELETE FROM todos WHERE id IN (%s)", strings.Join(ids, ","))
tx.ExecContext(ctx, query)
```

**é£é™©**ï¼š
- å¦‚æœ `ids` æ˜¯ä»ç”¨æˆ·è¾“å…¥è§£æçš„å­—ç¬¦ä¸²ï¼ˆè€Œä¸æ˜¯ `int`ï¼‰ï¼Œå¯èƒ½åŒ…å«æ¶æ„ä»£ç 
- ç¤ºä¾‹ï¼š`ids = ["1", "2; DROP TABLE todos;"]`

**æ­£ç¡®ä»£ç **ï¼š
```go
// âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆæ¯ä¸ª ID å•ç‹¬ç»‘å®šï¼‰
for _, id := range ids {
    tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
}

// æˆ–è€…ä½¿ç”¨ IN å­å¥ï¼ˆæ„é€ å ä½ç¬¦ï¼‰
placeholders := make([]string, len(ids))
args := make([]interface{}, len(ids))
for i, id := range ids {
    placeholders[i] = "?"
    args[i] = id
}
query := fmt.Sprintf("DELETE FROM todos WHERE id IN (%s)", strings.Join(placeholders, ","))
tx.ExecContext(ctx, query, args...)
```

---

### 6. **å¹¶å‘åˆ é™¤çš„ç«æ€æ¡ä»¶**

**åœºæ™¯**ï¼š
- ç”¨æˆ· A æ‰¹é‡åˆ é™¤ [1, 2, 3]
- ç”¨æˆ· B åŒæ—¶æ‰¹é‡åˆ é™¤ [2, 3, 4]

**SQLite çš„è¡Œä¸º**ï¼š
- SQLite ä½¿ç”¨æ–‡ä»¶é”ï¼Œäº‹åŠ¡ä¸²è¡Œæ‰§è¡Œ
- å…ˆæäº¤çš„äº‹åŠ¡æˆåŠŸï¼Œåæäº¤çš„äº‹åŠ¡ï¼š
  - ID=2,3 å·²è¢«åˆ é™¤ â†’ `RowsAffected=0` â†’ æ ‡è®°ä¸ºå¤±è´¥

**ç»“æœ**ï¼š
- ç”¨æˆ· Aï¼šSuccessCount=3
- ç”¨æˆ· Bï¼šSuccessCount=1ï¼ˆID=4ï¼‰ï¼ŒFailedCount=2ï¼ˆID=2,3 ä¸å­˜åœ¨ï¼‰

**è¿™æ˜¯é¢„æœŸè¡Œä¸º**ï¼ˆéƒ¨åˆ†å¤±è´¥ç­–ç•¥çš„å¥½å¤„ï¼‰ï¼

---

## ğŸ› ï¸ å®ç°æ­¥éª¤å»ºè®®

### æ¸è¿›å¼å®ç°ï¼ˆåˆ† 4 æ­¥ï¼‰

> **å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆæ•™å­¦-5ï¼ˆå…¨æœ‰æˆ–å…¨æ— ç­–ç•¥çš„æ‰¹é‡æ“ä½œï¼‰ã€‚
> æœ¬èŠ‚åœ¨å…¶åŸºç¡€ä¸Šæ‰©å±•ä¸ºéƒ¨åˆ†æˆåŠŸç­–ç•¥ã€‚

**ç¬¬ 1 æ­¥**ï¼šå›é¡¾æ•™å­¦-5çš„å®ç°ï¼ˆå…¨æœ‰æˆ–å…¨æ— ï¼‰

æ•™å­¦-5 å·²å®ç°ï¼š
```go
// å…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼šä»»ä½•å¤±è´¥éƒ½å›æ»š
func (db *DB) BatchDeleteTodosContext(ctx context.Context, ids []int) error {
    tx, err := db.conn.BeginTx(ctx, nil)
    // ...
    for _, id := range ids {
        _, err = tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
        if err != nil {
            return err  // ä»»ä½•å¤±è´¥éƒ½å›æ»š
        }
    }
    // ...
}
```

---

**ç¬¬ 2 æ­¥**ï¼šæ·»åŠ  `BatchResult` ç»“æ„å’Œéƒ¨åˆ†å¤±è´¥æ”¯æŒ

```go
type BatchResult struct {
    SuccessCount int          `json:"success_count"`
    FailedCount  int          `json:"failed_count"`
    Errors       []BatchError `json:"errors,omitempty"`
}

func (db *DB) BatchDeleteTodosPartialContext(ctx context.Context, ids []int) (*BatchResult, error) {
    // ... åˆå§‹åŒ– ...
    tx, err := db.conn.BeginTx(ctx, nil)
    // ...

    result := &BatchResult{Errors: make([]BatchError, 0)}

    for _, id := range ids {
        select {
        case <-ctx.Done():
            return nil, ctx.Err()
        default:
        }

        res, execErr := tx.ExecContext(ctx, "DELETE FROM todos WHERE id = ?", id)
        if execErr != nil {
            result.FailedCount++
            result.Errors = append(result.Errors, BatchError{ID: id, Error: execErr.Error()})
            continue  // å…³é”®åŒºåˆ«ï¼šç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
        }

        rows, _ := res.RowsAffected()
        if rows == 0 {
            result.FailedCount++
            result.Errors = append(result.Errors, BatchError{ID: id, Error: "ä¸å­˜åœ¨"})
        } else {
            result.SuccessCount++
        }
    }

    tx.Commit()
    return result, nil
}
```

**æµ‹è¯•**ï¼š
```bash
# åˆ é™¤å­˜åœ¨çš„å’Œä¸å­˜åœ¨çš„ ID
curl -X POST http://localhost:7789/api/v1/todos/batch/delete \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 999, 2]}'

# é¢„æœŸè¿”å›
{
  "success": true,
  "data": {
    "success_count": 2,
    "failed_count": 1,
    "errors": [{"id": 999, "error": "ä¸å­˜åœ¨"}]
  }
}
```

---

**ç¬¬ 3 æ­¥**ï¼šå®ç°æ‰¹é‡å®Œæˆï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰

```go
func (db *DB) BatchCompleteTodosPartialContext(ctx context.Context, ids []int) (*BatchResult, error) {
    // ... ä¸ BatchDeleteTodosPartialContext ç±»ä¼¼ ...

    for _, id := range ids {
        // åœ¨ Go å±‚ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç»Ÿä¸€ä½¿ç”¨ UTCï¼‰
        now := time.Now().UTC()

        res, execErr := tx.ExecContext(ctx, `
            UPDATE todos
            SET status = 'completed', completed_at = ?, updated_at = ?
            WHERE id = ? AND status = 'pending'
        `, now, now, id)

        // ... å¤„ç†ç»“æœï¼ˆä¸åˆ é™¤ç±»ä¼¼ï¼‰...
    }

    tx.Commit()
    return result, nil
}
```

---

**ç¬¬ 4 æ­¥**ï¼šæ·»åŠ æ‰¹é‡å¤§å°é™åˆ¶å’ŒéªŒè¯

```go
func (db *DB) BatchDeleteTodosPartialContext(ctx context.Context, ids []int) (*BatchResult, error) {
    if len(ids) == 0 {
        return &BatchResult{}, nil
    }

    if len(ids) > 100 {
        return nil, fmt.Errorf("æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: %d", len(ids))
    }

    // ... å…¶ä½™é€»è¾‘ ...
}
```

**æµ‹è¯•**ï¼š
```bash
# æµ‹è¯•è¶…è¿‡é™åˆ¶
curl -X POST http://localhost:7789/api/v1/todos/batch/delete \
  -H "Content-Type: application/json" \
  -d '{"ids": [1,2,3,...,101]}'  # 101 ä¸ª ID

# é¢„æœŸè¿”å› 400 é”™è¯¯
{
  "success": false,
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "æ‰¹é‡æ“ä½œæœ€å¤šæ”¯æŒ 100 ä¸ª IDï¼Œå½“å‰: 101"
  }
}
```

---

## âœ… éªŒè¯æ¸…å•

å®ç°å®Œæˆåï¼Œè¯·æ£€æŸ¥ï¼š

**åŠŸèƒ½æ­£ç¡®æ€§**ï¼š
- [ ] æ‰¹é‡åˆ é™¤æˆåŠŸï¼ˆæ‰€æœ‰ ID éƒ½å­˜åœ¨ï¼‰
- [ ] æ‰¹é‡å®ŒæˆæˆåŠŸï¼ˆæ‰€æœ‰ ID éƒ½æ˜¯ pending çŠ¶æ€ï¼‰
- [ ] éƒ¨åˆ†å¤±è´¥å¤„ç†ï¼ˆè¿”å›æ­£ç¡®çš„ SuccessCount å’Œ FailedCountï¼‰
- [ ] ç©ºåˆ—è¡¨å¤„ç†ï¼ˆè¿”å›æˆåŠŸï¼Œè®¡æ•°ä¸º 0ï¼‰
- [ ] ID ä¸å­˜åœ¨çš„æƒ…å†µï¼ˆè®°å½•åˆ° Errorsï¼‰
- [ ] å·²å®Œæˆçš„å¾…åŠæ— æ³•å†æ¬¡å®Œæˆï¼ˆè®°å½•åˆ° Errorsï¼‰
- [ ] è¶…æ—¶æƒ…å†µè¿”å›æ­£ç¡®çš„é”™è¯¯ç ï¼ˆ408ï¼‰

**Context æ”¯æŒ**ï¼ˆä¸æ•™å­¦-5ä¸€è‡´ï¼‰ï¼š
- [ ] ä½¿ç”¨ `BeginTx(ctx, nil)` è€Œä¸æ˜¯ `Begin()`
- [ ] ä½¿ç”¨ `ExecContext(ctx, ...)` è€Œä¸æ˜¯ `Exec(...)`
- [ ] åœ¨å¾ªç¯ä¸­æ£€æŸ¥ `ctx.Done()`ï¼ˆå…è®¸ä¸­æ–­ï¼‰
- [ ] Handler å±‚ä½¿ç”¨ `context.WithTimeout` åˆ›å»ºè¶…æ—¶
- [ ] åŒºåˆ† `context.DeadlineExceeded` å’Œ `context.Canceled`

**äº‹åŠ¡æ€§**ï¼š
- [ ] Commit å¤±è´¥æ—¶æ­£ç¡®è¿”å›é”™è¯¯
- [ ] äº‹åŠ¡ä¸­ä»»ä½•å¤±è´¥éƒ½è®°å½•ï¼ˆä¸ä¼šé™é»˜ä¸¢å¤±ï¼‰
- [ ] defer Rollback æ­£ç¡®å¤„ç†é”™è¯¯æƒ…å†µ
- [ ] è®°å½• `Rollback()` å¤±è´¥çš„æƒ…å†µ

**å®‰å…¨æ€§**ï¼š
- [ ] æ‰¹é‡å¤§å°é™åˆ¶ï¼ˆæœ€å¤š 100 ä¸ªï¼ŒHandler å’Œ DB åŒé‡æ ¡éªŒï¼‰
- [ ] ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ï¼ˆæ—  SQL æ³¨å…¥é£é™©ï¼‰
- [ ] IDs ä¸ºç©ºæ—¶è¿”å› 400 é”™è¯¯

**API è®¾è®¡**ï¼š
- [ ] è·¯ç”±æ³¨å†Œé¡ºåºæ­£ç¡®ï¼ˆ/batch/* åœ¨ /{id} ä¹‹å‰ï¼‰
- [ ] åŒæ—¶æ”¯æŒ `/api/v1/todos/batch/*` å’Œ `/api/todos/batch/*`
- [ ] å“åº”æ ¼å¼ç¬¦åˆé¡¹ç›®è§„èŒƒ

**ä»£ç è´¨é‡**ï¼š
- [ ] å‡½æ•°å‘½åå¸¦ `Context` åç¼€ï¼ˆä¸é¡¹ç›®é£æ ¼ä¸€è‡´ï¼‰
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] æœ‰æ¸…æ™°çš„æ³¨é‡Š
- [ ] ä»£ç æ ¼å¼ç¬¦åˆ gofmt

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### å®Œæ•´æµ‹è¯•è„šæœ¬

> **æ³¨æ„**ï¼šä»¥ä¸‹è„šæœ¬å‡è®¾ä½ é€‰æ‹©äº†**é€‰é¡¹ A**ï¼ˆæ›¿æ¢åŸæœ‰ç«¯ç‚¹ï¼‰ã€‚
> å¦‚æœé€‰æ‹©**é€‰é¡¹ B**ï¼ˆä¿ç•™ä¸¤ç§ç­–ç•¥ï¼‰ï¼Œè¯·å°†ç«¯ç‚¹æ”¹ä¸º `/batch/complete-partial` å’Œ `/batch/delete-partial`ã€‚

```bash
#!/bin/bash

BASE_URL="http://localhost:7789/api/v1/todos"

echo "=== å‡†å¤‡æµ‹è¯•æ•°æ® ==="
# åˆ›å»º 10 ä¸ªå¾…åŠäº‹é¡¹
for i in {1..10}; do
  curl -s -X POST "$BASE_URL" \
    -H "Content-Type: application/json" \
    -d "{\"title\": \"æµ‹è¯•ä»»åŠ¡ $i\", \"description\": \"æè¿° $i\"}" > /dev/null
  echo "åˆ›å»ºä»»åŠ¡ $i"
done

echo -e "\n=== æµ‹è¯• 1: æ‰¹é‡å®Œæˆï¼ˆå…¨éƒ¨æˆåŠŸï¼‰==="
curl -s -X POST "$BASE_URL/batch/complete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 2, 3]}' | jq

echo -e "\n=== æµ‹è¯• 2: æ‰¹é‡å®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ - å·²å®Œæˆçš„ï¼‰==="
curl -s -X POST "$BASE_URL/batch/complete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [1, 4, 5]}' | jq
# é¢„æœŸï¼šID=1 å·²å®Œæˆï¼Œå¤±è´¥ï¼›ID=4,5 æˆåŠŸ

echo -e "\n=== æµ‹è¯• 3: æ‰¹é‡å®Œæˆï¼ˆéƒ¨åˆ†å¤±è´¥ - ID ä¸å­˜åœ¨ï¼‰==="
curl -s -X POST "$BASE_URL/batch/complete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [6, 999, 7]}' | jq
# é¢„æœŸï¼šID=999 ä¸å­˜åœ¨ï¼Œå¤±è´¥ï¼›ID=6,7 æˆåŠŸ

echo -e "\n=== æµ‹è¯• 4: æ‰¹é‡åˆ é™¤ï¼ˆå…¨éƒ¨æˆåŠŸï¼‰==="
curl -s -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [8, 9, 10]}' | jq

echo -e "\n=== æµ‹è¯• 5: æ‰¹é‡åˆ é™¤ï¼ˆéƒ¨åˆ†å¤±è´¥ - ID ä¸å­˜åœ¨ï¼‰==="
curl -s -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [8, 9, 10]}' | jq
# é¢„æœŸï¼šå…¨éƒ¨å¤±è´¥ï¼ˆå·²è¢«åˆ é™¤ï¼‰

echo -e "\n=== æµ‹è¯• 6: ç©º IDs åˆ—è¡¨ ==="
curl -s -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d '{"ids": []}' | jq
# é¢„æœŸï¼š400 é”™è¯¯

echo -e "\n=== æµ‹è¯• 7: è¶…è¿‡é™åˆ¶ï¼ˆ101 ä¸ª IDï¼‰==="
IDS=$(seq -s ',' 1 101)
curl -s -X POST "$BASE_URL/batch/delete" \
  -H "Content-Type: application/json" \
  -d "{\"ids\": [$IDS]}" | jq
# é¢„æœŸï¼š400 é”™è¯¯

echo -e "\n=== æµ‹è¯• 8: å‘åå…¼å®¹ï¼ˆ/api/todos/batch/*ï¼‰==="
curl -s -X POST "http://localhost:7789/api/todos/batch/complete" \
  -H "Content-Type: application/json" \
  -d '{"ids": [4, 5]}' | jq

echo -e "\n=== æ¸…ç† ==="
# åˆ é™¤æ‰€æœ‰æµ‹è¯•æ•°æ®ï¼ˆæ‰‹åŠ¨æˆ–é€šè¿‡ APIï¼‰
```

ä¿å­˜ä¸º `scripts/test-batch-partial.sh`ï¼Œç„¶åæ‰§è¡Œï¼š
```bash
chmod +x scripts/test-batch-partial.sh
./scripts/test-batch-partial.sh
```

> **æç¤º**ï¼šå¦‚æœæ•™å­¦-5çš„æµ‹è¯•è„šæœ¬æ˜¯ `scripts/test-batch.sh`ï¼Œ
> å»ºè®®å°†æœ¬èŠ‚çš„è„šæœ¬å‘½åä¸º `scripts/test-batch-partial.sh` ä»¥åŒºåˆ†ã€‚

---

## ğŸ“– æ‰©å±•é˜…è¯»

### Go æ•°æ®åº“äº‹åŠ¡
- [`database/sql` Transactions](https://go.dev/doc/database/execute-transactions)
- [Handling Errors in Transactions](https://go.dev/doc/database/querying#handling-errors)

### SQLite äº‹åŠ¡æœºåˆ¶
- [Transaction](https://www.sqlite.org/lang_transaction.html)
- [Locking And Concurrency](https://www.sqlite.org/lockingv3.html)

### æ‰¹é‡æ“ä½œæœ€ä½³å®è·µ
- [Batch Processing Patterns](https://martinfowler.com/articles/patterns-of-distributed-systems/batch-processing.html)
- [Database Batch Operations](https://en.wikipedia.org/wiki/Batch_processing)

---

## ğŸš€ å¼€å§‹å®ç°å§ï¼

ç°åœ¨è¯·ä½ æŒ‰ç…§ä»¥ä¸Šæ­¥éª¤ï¼ˆå‡è®¾æ•™å­¦-5å·²å®Œæˆï¼‰ï¼š

1. **ä¿®æ”¹ `database/db.go`**ï¼š
   - æ·»åŠ  `BatchError` å’Œ `BatchResult` ç»“æ„ä½“
   - å®ç° `BatchCompleteTodosPartialContext()` å‡½æ•°ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰
   - å®ç° `BatchDeleteTodosPartialContext()` å‡½æ•°ï¼ˆéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼‰

2. **ä¿®æ”¹ `handler/handler.go`**ï¼š
   - å¤ç”¨æ•™å­¦-5çš„ `BatchRequest` ç»“æ„ä½“
   - å®ç° `BatchCompleteTodosPartial` handlerï¼ˆå¸¦ Context è¶…æ—¶ï¼‰
   - å®ç° `BatchDeleteTodosPartial` handlerï¼ˆå¸¦ Context è¶…æ—¶ï¼‰

3. **ä¿®æ”¹ `api/routes.go`**ï¼š
   - é€‰æ‹©æ›¿æ¢åŸæœ‰ç«¯ç‚¹æˆ–æ·»åŠ æ–°ç«¯ç‚¹ï¼ˆè§é€‰é¡¹ A/Bï¼‰
   - æ³¨æ„è·¯ç”±é¡ºåºï¼ˆåœ¨ `/{id}` ä¹‹å‰ï¼‰

4. **æµ‹è¯•**ï¼š
   - ä½¿ç”¨ä¸Šé¢çš„æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½
   - ç¡®ä¿éƒ¨åˆ†å¤±è´¥ã€ç©ºåˆ—è¡¨ã€è¶…é™ã€è¶…æ—¶ç­‰è¾¹ç•Œæƒ…å†µéƒ½æ­£ç¡®å¤„ç†

**è®°ä½**ï¼ˆä¸æ•™å­¦-5çš„åŒºåˆ«ï¼‰ï¼š
- ä½¿ç”¨ `continue` è·³è¿‡å¤±è´¥é¡¹ï¼ˆè€Œé `return` å›æ»šï¼‰
- ä½¿ç”¨ `RowsAffected()` åŒºåˆ†"æ‰§è¡Œå¤±è´¥"å’Œ"ID ä¸å­˜åœ¨"
- å³ä½¿æœ‰å¤±è´¥ï¼Œä¹Ÿè¦ `Commit` æˆåŠŸçš„æ“ä½œ
- è¿”å› `BatchResult` è€Œé `error`

**ä¸æ•™å­¦-5çš„å¯¹æ¯”**ï¼š
| ç‰¹æ€§ | æ•™å­¦-5ï¼ˆå…¨æœ‰æˆ–å…¨æ— ï¼‰ | æ•™å­¦-6ï¼ˆéƒ¨åˆ†æˆåŠŸï¼‰ |
|------|---------------------|-------------------|
| å¤±è´¥å¤„ç† | ä»»ä½•å¤±è´¥éƒ½å›æ»š | è®°å½•å¤±è´¥ï¼Œç»§ç»­å¤„ç† |
| è¿”å›å€¼ | `error` | `*BatchResult, error` |
| ç”¨æˆ·ä½“éªŒ | "1ä¸ªå¤±è´¥ï¼Œå…¨éƒ¨å–æ¶ˆ" | "19ä¸ªæˆåŠŸï¼Œ1ä¸ªå¤±è´¥" |
| å¤æ‚åº¦ | ç®€å• | ä¸­ç­‰ |

é‡åˆ°é—®é¢˜éšæ—¶é—®æˆ‘ï¼ğŸ’ª

---

## ğŸ’¡ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸ç”¨ IN å­å¥ï¼Ÿ

**é—®é¢˜**ï¼š`DELETE FROM todos WHERE id IN (1,2,3)` ä¸æ˜¯æ›´å¿«å—ï¼Ÿ

**ç­”**ï¼š
- **æ€§èƒ½**ï¼šIN å­å¥ç¡®å®æ›´å¿«ï¼ˆ1 æ¬¡ SQL vs 3 æ¬¡ï¼‰
- **é”™è¯¯å¤„ç†**ï¼šæ— æ³•åŒºåˆ†å“ªä¸ª ID å¤±è´¥äº†
  ```sql
  DELETE FROM todos WHERE id IN (1, 999, 2)
  -- RowsAffected = 2ï¼Œä½†æ— æ³•çŸ¥é“æ˜¯å“ªä¸¤ä¸ªæˆåŠŸäº†
  ```
- **æœ¬é¡¹ç›®**ï¼šå¾ªç¯é€ä¸ªå¤„ç†ï¼Œä¾¿äºè®°å½•æ¯ä¸ª ID çš„ç»“æœ

**å¦‚æœè¿½æ±‚æ€§èƒ½**ï¼š
```go
// å…ˆç”¨ IN å­å¥åˆ é™¤
res, _ := tx.ExecContext(ctx, "DELETE FROM todos WHERE id IN (?, ?, ?)", ids...)
// å†é€ä¸ªæŸ¥è¯¢å“ªäº›è¿˜å­˜åœ¨ï¼ˆå¤±è´¥çš„ï¼‰
for _, id := range ids {
    var exists int
    tx.QueryRowContext(ctx, "SELECT 1 FROM todos WHERE id = ?", id).Scan(&exists)
    if exists == 1 {
        result.Errors = append(...)
    }
}
```

### Q2: æ‰¹é‡æ“ä½œä¼šé”è¡¨å¤šä¹…ï¼Ÿ

**ç­”**ï¼š
- SQLite ä½¿ç”¨æ–‡ä»¶é”ï¼Œäº‹åŠ¡æœŸé—´æ•´ä¸ªæ•°æ®åº“è¢«é”å®š
- 100 ä¸ªåˆ é™¤æ“ä½œçº¦ 50-100ms
- å…¶ä»–è¯·æ±‚ä¼šè¢«é˜»å¡ï¼ˆç­‰å¾…é”é‡Šæ”¾ï¼‰
- **ç¼“è§£**ï¼šæ‰¹é‡å¤§å°é™åˆ¶åœ¨ 100 ä»¥å†…

### Q3: å¦‚æœæ‰¹é‡ 1000 ä¸ªæ€ä¹ˆåŠï¼Ÿ

**ç­”**ï¼š
- å‰ç«¯åˆ†æ‰¹å‘é€ï¼ˆæ¯æ‰¹ 100 ä¸ªï¼‰
- æˆ–è€…åç«¯æ”¯æŒ"åˆ†é¡µæ‰¹é‡"ï¼š
  ```go
  for i := 0; i < len(ids); i += 100 {
      batch := ids[i:min(i+100, len(ids))]
      result := BatchDelete(batch)
      // åˆå¹¶ç»“æœ
  }
  ```

### Q4: æ‰¹é‡å®Œæˆåï¼Œå‰ç«¯å¦‚ä½•åˆ·æ–°åˆ—è¡¨ï¼Ÿ

**ç­”**ï¼š
```javascript
const result = await batchComplete([1, 2, 3]);
if (result.failed_count > 0) {
    alert(`${result.failed_count} ä¸ªä»»åŠ¡æ“ä½œå¤±è´¥`);
}
// é‡æ–°åŠ è½½åˆ—è¡¨
fetchTodos();
```

### Q5: èƒ½å¦æ”¯æŒæ‰¹é‡æ›´æ–°ï¼ˆä¿®æ”¹æ ‡é¢˜ã€æˆªæ­¢æ—¥æœŸç­‰ï¼‰ï¼Ÿ

**ç­”**ï¼š
- å¯ä»¥ï¼Œä½† API è®¾è®¡ä¼šæ›´å¤æ‚ï¼š
  ```json
  {
    "updates": [
      {"id": 1, "title": "æ–°æ ‡é¢˜"},
      {"id": 2, "due_date": "2024-12-31"}
    ]
  }
  ```
- æ¯ä¸ª ID çš„æ›´æ–°å­—æ®µå¯èƒ½ä¸åŒ
- å»ºè®®ï¼šå…ˆå®ç°ç®€å•çš„æ‰¹é‡å®Œæˆ/åˆ é™¤ï¼Œå†è€ƒè™‘æ‰©å±•

---

## ğŸ¯ æ€»ç»“

**æ•™å­¦-5 vs æ•™å­¦-6**ï¼š
- æ•™å­¦-5ï¼šå…¨æœ‰æˆ–å…¨æ— ç­–ç•¥ï¼ˆç®€å•ï¼Œé€‚åˆå¼ºä¸€è‡´æ€§åœºæ™¯ï¼‰
- æ•™å­¦-6ï¼šéƒ¨åˆ†æˆåŠŸç­–ç•¥ï¼ˆå¤æ‚ï¼Œé€‚åˆç”¨æˆ·å‹å¥½åœºæ™¯ï¼‰

**ä½•æ—¶ä½¿ç”¨å“ªç§ç­–ç•¥ï¼Ÿ**
- **å…¨æœ‰æˆ–å…¨æ— **ï¼šè½¬è´¦ã€è®¢å•åˆ›å»ºç­‰éœ€è¦å¼ºä¸€è‡´æ€§çš„åœºæ™¯
- **éƒ¨åˆ†æˆåŠŸ**ï¼šæ‰¹é‡åˆ é™¤ã€æ‰¹é‡æ ‡è®°ç­‰ç”¨æˆ·æ“ä½œï¼Œå…è®¸éƒ¨åˆ†å¤±è´¥

**æ ¸å¿ƒè¦ç‚¹**ï¼š
1. Context æ”¯æŒï¼š`BeginTx`ã€`ExecContext`ã€å¾ªç¯ä¸­æ£€æŸ¥ `ctx.Done()`
2. éƒ¨åˆ†å¤±è´¥ï¼š`continue` è·³è¿‡å¤±è´¥ï¼Œè®°å½• `BatchError`
3. äº‹åŠ¡æäº¤ï¼šå³ä½¿æœ‰å¤±è´¥ï¼ŒæˆåŠŸçš„ä¹Ÿè¦ `Commit`

**ç°åœ¨ï¼Œå¼€å§‹å®ç°éƒ¨åˆ†æˆåŠŸç­–ç•¥çš„æ‰¹é‡æ“ä½œå§ï¼** ğŸš€
