# æ•™å­¦ Part 6: ä¼˜é›…å…³é—­ (Graceful Shutdown)

> **ğŸ“Œ å­¦ä¹ é˜¶æ®µ**: ä¸­çº§ / ç”Ÿäº§çº§å¯é æ€§
> **å‰ç½®è¦æ±‚**: å·²æŒæ¡ Contextã€goroutine åŸºç¡€
> **å­¦ä¹ ç›®æ ‡**: å®ç°ä¼˜é›…å…³é—­ã€é˜²æ­¢æ•°æ®ä¸¢å¤±ã€ç¡®ä¿è¯·æ±‚å®Œæ•´å¤„ç†
> **æ—¶é—´æŠ•å…¥**: 2-3 å°æ—¶(ç†è§£åŸç† + å®ç° + æµ‹è¯•)

---

## ğŸ¯ åŠŸèƒ½åˆ†æ - Linus å¼æ€è€ƒ

### Linus çš„ä¸‰ä¸ªé—®é¢˜

**1. "è¿™æ˜¯ä¸ªçœŸé—®é¢˜è¿˜æ˜¯è‡†æƒ³å‡ºæ¥çš„?"**

âœ… **çœŸå®é—®é¢˜**:
- éƒ¨ç½²æ–°ç‰ˆæœ¬æ—¶,ç›´æ¥ `kill` è¿›ç¨‹ â†’ æ­£åœ¨å¤„ç†çš„è¯·æ±‚è¢«å¼ºåˆ¶ä¸­æ–­ â†’ æ•°æ®ä¸ä¸€è‡´
- ç”¨æˆ·æ­£åœ¨åˆ›å»º Todo â†’ æœåŠ¡å™¨é‡å¯ â†’ è¯·æ±‚å¤±è´¥,ä½†ä¸çŸ¥é“æ˜¯å¦åˆ›å»ºæˆåŠŸ
- æ•°æ®åº“è¿æ¥åœ¨ä½¿ç”¨ä¸­è¢«å…³é—­ â†’ SQLite æ–‡ä»¶æŸå

**ç”Ÿäº§ç¯å¢ƒçš„çœŸå®åœºæ™¯**:
```
15:00:00 - ç”¨æˆ·æäº¤åˆ›å»º Todo è¯·æ±‚
15:00:01 - æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚,å¼€å§‹å†™å…¥æ•°æ®åº“
15:00:02 - è¿ç»´æ‰§è¡Œ `systemctl restart todo-server`
15:00:02 - æœåŠ¡å™¨ç«‹å³é€€å‡º â†’ æ•°æ®åº“å†™å…¥ä¸­æ–­ â†’ ç”¨æˆ·æ”¶åˆ° 500 é”™è¯¯
15:00:03 - ç”¨æˆ·åˆ·æ–°é¡µé¢,çœ‹åˆ° Todo æ²¡æœ‰åˆ›å»º â†’ ç–‘æƒ‘:"åˆšæ‰æäº¤äº†å—?"
```

**ä¸ºä»€ä¹ˆéœ€è¦ä¼˜é›…å…³é—­?**
- **å®Œæˆæ­£åœ¨å¤„ç†çš„è¯·æ±‚**(ä¸ä¸¢å¤±ç”¨æˆ·æ“ä½œ)
- **å…³é—­æ•°æ®åº“è¿æ¥**(é˜²æ­¢æ–‡ä»¶æŸå)
- **é‡Šæ”¾èµ„æº**(æ¸…ç†ä¸´æ—¶æ–‡ä»¶ã€å…³é—­æ—¥å¿—)
- **é›¶åœæœºéƒ¨ç½²**(é…åˆè´Ÿè½½å‡è¡¡)

**2. "æœ‰æ›´ç®€å•çš„æ–¹æ³•å—?"**

ğŸ’¡ **æ ¸å¿ƒæ€è·¯**: ä¿¡å·å¤„ç† + ç­‰å¾…è¶…æ—¶

**é”™è¯¯æ–¹æ³•**(ç›´æ¥é€€å‡º):
```go
// âŒ main å‡½æ•°ç»“æŸ â†’ ç¨‹åºç«‹å³é€€å‡º
func main() {
    http.ListenAndServe(":7789", handler)
    // æ²¡æœ‰ç­‰å¾…è¯·æ±‚å®Œæˆ
}
```

**æ­£ç¡®æ–¹æ³•**(ä¼˜é›…å…³é—­):
```go
// âœ… ç›‘å¬ä¿¡å· â†’ åœæ­¢æ¥å—æ–°è¯·æ±‚ â†’ ç­‰å¾…æ—§è¯·æ±‚å®Œæˆ â†’ å…³é—­èµ„æº
func main() {
    server := &http.Server{Addr: ":7789"}

    // å¯åŠ¨æœåŠ¡å™¨(éé˜»å¡)
    go server.ListenAndServe()

    // ç­‰å¾…ä¸­æ–­ä¿¡å·
    <-sigChan

    // ä¼˜é›…å…³é—­(ç­‰å¾… 30 ç§’)
    ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
    defer cancel()
    server.Shutdown(ctx)
}
```

**3. "ä¼šç ´åä»€ä¹ˆå—?"**

âš ï¸ **æ½œåœ¨é£é™©**:
- ç­‰å¾…æ—¶é—´å¤ªé•¿ â†’ éƒ¨ç½²å»¶è¿Ÿ(ç”¨æˆ·ç­‰å¾…æ–°ç‰ˆæœ¬)
- ç­‰å¾…æ—¶é—´å¤ªçŸ­ â†’ è¯·æ±‚è¢«ä¸­æ–­(å’Œæ²¡æœ‰ä¼˜é›…å…³é—­ä¸€æ ·)
- ä¿¡å·å¤„ç†ä¸å½“ â†’ æ— æ³•æ­£å¸¸é€€å‡º(Kubernetes å¼ºåˆ¶ kill)

âœ… **å®‰å…¨è®¾è®¡**:
- åˆç†çš„è¶…æ—¶æ—¶é—´(30 ç§’)
- è®°å½•æ—¥å¿—(å“ªäº›è¯·æ±‚è¢«ä¸­æ–­äº†)
- å¥åº·æ£€æŸ¥é…åˆ(Kubernetes å…ˆæ ‡è®° unhealthy,å†å…³é—­)

---

## ğŸ“š æ ¸å¿ƒçŸ¥è¯†è®²è§£

### 1. æ“ä½œç³»ç»Ÿä¿¡å· (OS Signals)

**ä»€ä¹ˆæ˜¯ä¿¡å·?**
- æ“ä½œç³»ç»Ÿå‘è¿›ç¨‹å‘é€çš„é€šçŸ¥
- å‘Šè¯‰è¿›ç¨‹"è¯¥åšæŸäº‹äº†"(ç»ˆæ­¢ã€é‡è½½é…ç½®ç­‰)

**å¸¸è§ä¿¡å·**:
```go
SIGINT  (Ctrl+C)        - ç”¨æˆ·ä¸­æ–­(ç»ˆç«¯æŒ‰ Ctrl+C)
SIGTERM (kill <pid>)    - ç»ˆæ­¢è¯·æ±‚(systemd/k8s å‘é€)
SIGKILL (kill -9 <pid>) - å¼ºåˆ¶æ€æ­»(æ— æ³•æ•è·,ç«‹å³é€€å‡º)
SIGHUP  (é…ç½®é‡è½½)      - æŒ‚èµ·(é€šå¸¸ç”¨äºé‡è½½é…ç½®)
```

**ä¸ºä»€ä¹ˆ SIGKILL æ— æ³•æ•è·?**
- è¿™æ˜¯æ“ä½œç³»ç»Ÿçš„"æ ¸æ­¦å™¨",ç¡®ä¿è¿›ç¨‹ä¸€å®šèƒ½è¢«æ€æ­»
- ç”¨äºå¤„ç†"æ— å“åº”"çš„è¿›ç¨‹
- Kubernetes ä¼šå…ˆå‘ SIGTERM,ç­‰å¾… 30 ç§’,ç„¶åå‘ SIGKILL

---

### 2. Go çš„ä¿¡å·å¤„ç†

**æ•è·ä¿¡å·çš„æ ‡å‡†æ¨¡å¼**:
```go
import (
    "os"
    "os/signal"
    "syscall"
)

func main() {
    // 1. åˆ›å»ºä¿¡å·é€šé“
    sigChan := make(chan os.Signal, 1)

    // 2. æ³¨å†Œè¦æ•è·çš„ä¿¡å·
    signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)

    // 3. å¯åŠ¨æœåŠ¡å™¨(éé˜»å¡)
    go server.ListenAndServe()

    // 4. é˜»å¡ç­‰å¾…ä¿¡å·
    sig := <-sigChan
    fmt.Printf("æ”¶åˆ°ä¿¡å·: %v\n", sig)

    // 5. æ‰§è¡Œæ¸…ç†å·¥ä½œ
    cleanup()
}
```

**å…³é”®ç‚¹**:
- `signal.Notify` ä¸ä¼šé˜»å¡,éœ€è¦æ‰‹åŠ¨ç­‰å¾…
- é€šé“ç¼“å†²åŒºè®¾ä¸º 1,é˜²æ­¢ä¿¡å·ä¸¢å¤±
- `os.Interrupt` å¯¹åº” `Ctrl+C`
- `syscall.SIGTERM` å¯¹åº” `kill <pid>`

---

### 3. http.Server çš„ä¼˜é›…å…³é—­

**`Shutdown()` æ–¹æ³•çš„è¡Œä¸º**:
```go
func (srv *Server) Shutdown(ctx context.Context) error
```

**æ‰§è¡Œæ­¥éª¤**:
1. **åœæ­¢æ¥å—æ–°è¿æ¥**(ç›‘å¬ socket å…³é—­)
2. **ç­‰å¾…æ‰€æœ‰æ´»è·ƒè¿æ¥ç©ºé—²**(è¯·æ±‚å¤„ç†å®Œæˆ)
3. **å…³é—­ç©ºé—²è¿æ¥**
4. **è¿”å›**(å¦‚æœè¶…æ—¶,è¿”å› context.DeadlineExceeded)

**ç¤ºä¾‹**:
```go
// ä¼˜é›…å…³é—­,æœ€å¤šç­‰å¾… 30 ç§’
ctx, cancel := context.WithTimeout(context.Background(), 30*time.Second)
defer cancel()

if err := server.Shutdown(ctx); err != nil {
    log.Printf("æœåŠ¡å™¨å…³é—­å¤±è´¥: %v", err)
    // å¼ºåˆ¶å…³é—­
    server.Close()
}
```

**æ³¨æ„äº‹é¡¹**:
- `Shutdown()` ä¸ä¼šä¸­æ–­ `ListenAndServe()`,éœ€è¦åœ¨ goroutine ä¸­å¯åŠ¨
- å¦‚æœè¶…æ—¶,éœ€è¦æ‰‹åŠ¨è°ƒç”¨ `Close()` å¼ºåˆ¶å…³é—­
- é•¿è¿æ¥(WebSocket)å¯èƒ½å¯¼è‡´é•¿æ—¶é—´ç­‰å¾…

---

### 4. å®Œæ•´çš„å…³é—­æµç¨‹

```
1. ç”¨æˆ·å‘é€ SIGTERM(æˆ– Ctrl+C)
   â†“
2. ç¨‹åºæ•è·ä¿¡å·,å¼€å§‹å…³é—­æµç¨‹
   â†“
3. HTTP æœåŠ¡å™¨åœæ­¢æ¥å—æ–°è¯·æ±‚
   â†“
4. ç­‰å¾…æ­£åœ¨å¤„ç†çš„è¯·æ±‚å®Œæˆ(æœ€å¤š 30 ç§’)
   â†“
5. å…³é—­æ•°æ®åº“è¿æ¥
   â†“
6. æ¸…ç†å…¶ä»–èµ„æº(ä¸´æ—¶æ–‡ä»¶ã€æ—¥å¿—)
   â†“
7. ç¨‹åºé€€å‡º
```

---

## ğŸ’» å®Œæ•´ä»£ç ç¤ºä¾‹

### æ–‡ä»¶: `cmd/server/main.go` - ä¼˜é›…å…³é—­å®ç°

```go
package main

import (
	"context"
	"fmt"
	"log"
	"net/http"
	"os"
	"os/signal"
	"syscall"
	"time"
	"todo-list/api"
	"todo-list/database"
	"todo-list/handler"
)

func main() {
	// æ•°æ®åº“è·¯å¾„(ä»ç¯å¢ƒå˜é‡è¯»å–,é»˜è®¤ ./todos.db)
	dbPath := os.Getenv("DB_PATH")
	if dbPath == "" {
		dbPath = "./todos.db"
	}

	// åˆå§‹åŒ–æ•°æ®åº“
	db, err := database.New(dbPath)
	if err != nil {
		log.Fatalf("Failed to initialize database: %v", err)
	}
	// æ³¨æ„:ä¸è¦åœ¨è¿™é‡Œ defer db.Close(),å› ä¸º main ä¸ä¼šç«‹å³é€€å‡º

	// åˆ›å»º Handler å’Œè·¯ç”±
	h := handler.NewHandler(db)
	mux := api.SetupRoutes(h)

	// é…ç½® HTTP æœåŠ¡å™¨
	server := &http.Server{
		Addr:         ":7789",
		Handler:      mux,
		ReadTimeout:  15 * time.Second, // è¯»å–è¯·æ±‚è¶…æ—¶
		WriteTimeout: 15 * time.Second, // å†™å…¥å“åº”è¶…æ—¶
		IdleTimeout:  60 * time.Second, // ç©ºé—²è¿æ¥è¶…æ—¶
	}

	// åˆ›å»ºä¿¡å·é€šé“(ç¼“å†²åŒº 1,é˜²æ­¢ä¿¡å·ä¸¢å¤±)
	sigChan := make(chan os.Signal, 1)
	signal.Notify(sigChan, os.Interrupt, syscall.SIGTERM)

	// åœ¨ goroutine ä¸­å¯åŠ¨æœåŠ¡å™¨(éé˜»å¡)
	go func() {
		log.Printf("æœåŠ¡å™¨å¯åŠ¨åœ¨ http://localhost%s", server.Addr)
		if err := server.ListenAndServe(); err != nil && err != http.ErrServerClosed {
			log.Fatalf("æœåŠ¡å™¨å¯åŠ¨å¤±è´¥: %v", err)
		}
	}()

	// é˜»å¡ç­‰å¾…ä¸­æ–­ä¿¡å·
	sig := <-sigChan
	log.Printf("æ”¶åˆ°ä¿¡å· %v,å¼€å§‹ä¼˜é›…å…³é—­...", sig)

	// åˆ›å»ºå…³é—­è¶…æ—¶çš„ Context
	shutdownCtx, shutdownCancel := context.WithTimeout(context.Background(), 30*time.Second)
	defer shutdownCancel()

	// ä¼˜é›…å…³é—­ HTTP æœåŠ¡å™¨
	if err := server.Shutdown(shutdownCtx); err != nil {
		log.Printf("æœåŠ¡å™¨å…³é—­è¶…æ—¶: %v,å¼ºåˆ¶å…³é—­", err)
		// å¼ºåˆ¶å…³é—­(ç«‹å³ä¸­æ–­æ‰€æœ‰è¿æ¥)
		if err := server.Close(); err != nil {
			log.Printf("å¼ºåˆ¶å…³é—­å¤±è´¥: %v", err)
		}
	} else {
		log.Println("HTTP æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­")
	}

	// å…³é—­æ•°æ®åº“è¿æ¥
	if err := db.Close(); err != nil {
		log.Printf("æ•°æ®åº“å…³é—­å¤±è´¥: %v", err)
	} else {
		log.Println("æ•°æ®åº“è¿æ¥å·²å…³é—­")
	}

	log.Println("æœåŠ¡å™¨å·²å®Œå…¨åœæ­¢")
}
```

---

## âš ï¸ å…³é”®ç‚¹è§£æ

### 1. ä¸ºä»€ä¹ˆè¦åœ¨ goroutine ä¸­å¯åŠ¨æœåŠ¡å™¨?

**é—®é¢˜ä»£ç **:
```go
// âŒ ListenAndServe ä¼šé˜»å¡,ä¸‹é¢çš„ä»£ç æ°¸è¿œä¸ä¼šæ‰§è¡Œ
server.ListenAndServe()
sig := <-sigChan  // æ°¸è¿œç­‰ä¸åˆ°
```

**æ­£ç¡®ä»£ç **:
```go
// âœ… goroutine ä¸­å¯åŠ¨,ä¸é˜»å¡ä¸» goroutine
go server.ListenAndServe()
sig := <-sigChan  // å¯ä»¥æ­£å¸¸ç­‰å¾…ä¿¡å·
```

---

### 2. ä¸ºä»€ä¹ˆä¿¡å·é€šé“ç¼“å†²åŒºæ˜¯ 1?

**æ— ç¼“å†²é€šé“**(å¯èƒ½ä¸¢å¤±ä¿¡å·):
```go
// âŒ å¦‚æœä¿¡å·åœ¨ Notify ä¹‹å‰åˆ°è¾¾,ä¼šä¸¢å¤±
sigChan := make(chan os.Signal)
signal.Notify(sigChan, os.Interrupt)
```

**æœ‰ç¼“å†²é€šé“**(ä¸ä¼šä¸¢å¤±):
```go
// âœ… ä¿¡å·å¯ä»¥å…ˆè¿›å…¥ç¼“å†²åŒº,ç­‰å¾…è¯»å–
sigChan := make(chan os.Signal, 1)
signal.Notify(sigChan, os.Interrupt)
```

---

### 3. å…³é—­è¶…æ—¶æ—¶é—´çš„é€‰æ‹©

**è¶…æ—¶æ—¶é—´å¦‚ä½•ç¡®å®š?**
- **å¤ªçŸ­**(5ç§’): å¤æ‚è¯·æ±‚å¯èƒ½è¢«ä¸­æ–­
- **å¤ªé•¿**(5åˆ†é’Ÿ): éƒ¨ç½²å»¶è¿Ÿè¿‡é•¿
- **æ¨è**: 30 ç§’(Kubernetes çš„é»˜è®¤å€¼)

**Kubernetes çš„å…³é—­æµç¨‹**:
```
1. kubelet å‘é€ SIGTERM
   â†“
2. ç­‰å¾… terminationGracePeriodSeconds(é»˜è®¤ 30 ç§’)
   â†“
3. å¦‚æœè¿›ç¨‹ä»å­˜åœ¨,å‘é€ SIGKILL(å¼ºåˆ¶æ€æ­»)
```

**å¦‚ä½•é…åˆ Kubernetes?**
```go
// åº”ç”¨çš„è¶…æ—¶åº”è¯¥ç•¥å°äº terminationGracePeriodSeconds
// ç•™å‡ºæ—¶é—´æ‰§è¡Œæ¸…ç†å·¥ä½œ(å…³é—­æ•°æ®åº“ç­‰)
shutdownTimeout := 30*time.Second - 2*time.Second  // 28 ç§’
```

---

### 4. å¼ºåˆ¶å…³é—­ vs ä¼˜é›…å…³é—­

**ä¼˜é›…å…³é—­å¤±è´¥æ—¶çš„å¤„ç†**:
```go
if err := server.Shutdown(ctx); err != nil {
    // è¶…æ—¶äº†,ä»æœ‰è¯·æ±‚æœªå®Œæˆ
    log.Printf("ä¼˜é›…å…³é—­è¶…æ—¶: %v", err)

    // è®°å½•å“ªäº›è¯·æ±‚è¢«ä¸­æ–­(å¯é€‰)
    // ...

    // å¼ºåˆ¶å…³é—­(ç«‹å³ä¸­æ–­æ‰€æœ‰è¿æ¥)
    server.Close()
}
```

**`Shutdown()` vs `Close()` çš„åŒºåˆ«**:
```go
// Shutdown(): ç­‰å¾…è¯·æ±‚å®Œæˆ,ç›´åˆ°è¶…æ—¶
err := server.Shutdown(ctx)  // å¯èƒ½ç­‰å¾… 30 ç§’

// Close(): ç«‹å³å…³é—­,ä¸­æ–­æ‰€æœ‰è¿æ¥
err := server.Close()  // ç«‹å³è¿”å›
```

---

### 5. æ•°æ®åº“å…³é—­çš„é¡ºåº

**æ­£ç¡®é¡ºåº**:
```go
// 1. å…ˆå…³é—­ HTTP æœåŠ¡å™¨(åœæ­¢æ¥å—è¯·æ±‚)
server.Shutdown(ctx)

// 2. å†å…³é—­æ•°æ®åº“(æ­¤æ—¶æ²¡æœ‰æ–°è¯·æ±‚)
db.Close()

// 3. å…¶ä»–æ¸…ç†å·¥ä½œ
cleanupTempFiles()
```

**é”™è¯¯é¡ºåº**:
```go
// âŒ å…ˆå…³é—­æ•°æ®åº“ â†’ HTTP è¯·æ±‚å°è¯•æŸ¥è¯¢ â†’ è¿æ¥å·²å…³é—­ â†’ panic
db.Close()
server.Shutdown(ctx)
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### æµ‹è¯•ä¼˜é›…å…³é—­

```bash
#!/bin/bash

# æµ‹è¯• 1: å¯åŠ¨æœåŠ¡å™¨
echo "=== å¯åŠ¨æœåŠ¡å™¨ ==="
go run cmd/server/main.go &
SERVER_PID=$!
sleep 2

# æµ‹è¯• 2: å‘é€ä¸€äº›è¯·æ±‚
echo -e "\n=== å‘é€æµ‹è¯•è¯·æ±‚ ==="
for i in {1..5}; do
  curl -s -X POST "http://localhost:7789/api/v1/todos" \
    -H "Content-Type: application/json" \
    -d "{\"title\": \"Task $i\"}" > /dev/null &
done

# æµ‹è¯• 3: æ¨¡æ‹Ÿé•¿æ—¶é—´è¯·æ±‚(åœ¨å¦ä¸€ä¸ªç»ˆç«¯ä¸­æ‰§è¡Œ)
# curl "http://localhost:7789/api/v1/todos?limit=10000" &

# æµ‹è¯• 4: å‘é€ SIGTERM ä¿¡å·
echo -e "\n=== å‘é€ SIGTERM ä¿¡å· ==="
kill -TERM $SERVER_PID

# æµ‹è¯• 5: è§‚å¯Ÿæ—¥å¿—
# åº”è¯¥çœ‹åˆ°:
# - "æ”¶åˆ°ä¿¡å· terminated,å¼€å§‹ä¼˜é›…å…³é—­..."
# - "HTTP æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­"
# - "æ•°æ®åº“è¿æ¥å·²å…³é—­"
# - "æœåŠ¡å™¨å·²å®Œå…¨åœæ­¢"

wait $SERVER_PID
echo -e "\n=== æœåŠ¡å™¨å·²åœæ­¢ ==="
```

---

### æµ‹è¯•è¶…æ—¶åœºæ™¯

```go
// æ¨¡æ‹Ÿæ…¢è¯·æ±‚(ç”¨äºæµ‹è¯•ä¼˜é›…å…³é—­è¶…æ—¶)
func (h *Handler) SlowRequest(w http.ResponseWriter, r *http.Request) {
    log.Println("æ…¢è¯·æ±‚å¼€å§‹...")

    // æ¨¡æ‹Ÿ 60 ç§’çš„å¤„ç†æ—¶é—´
    for i := 0; i < 60; i++ {
        select {
        case <-r.Context().Done():
            // Context å–æ¶ˆ,ç«‹å³è¿”å›
            log.Println("æ…¢è¯·æ±‚è¢«å–æ¶ˆ")
            return
        case <-time.After(1 * time.Second):
            log.Printf("æ…¢è¯·æ±‚å¤„ç†ä¸­... %d/60", i+1)
        }
    }

    log.Println("æ…¢è¯·æ±‚å®Œæˆ")
    w.Write([]byte("OK"))
}
```

**æµ‹è¯•æ­¥éª¤**:
1. æ·»åŠ æ…¢è¯·æ±‚ç«¯ç‚¹
2. å¯åŠ¨æœåŠ¡å™¨
3. å‘é€æ…¢è¯·æ±‚: `curl http://localhost:7789/api/slow &`
4. ç«‹å³å‘é€ SIGTERM: `kill <pid>`
5. è§‚å¯Ÿæ—¥å¿—:
   - å¦‚æœ 30 ç§’å†…å®Œæˆ â†’ "HTTP æœåŠ¡å™¨å·²ä¼˜é›…å…³é—­"
   - å¦‚æœ 30 ç§’æœªå®Œæˆ â†’ "æœåŠ¡å™¨å…³é—­è¶…æ—¶,å¼ºåˆ¶å…³é—­"

---

## âœ… éªŒè¯æ¸…å•

å®ç°å®Œæˆå,è¯·æ£€æŸ¥:

**åŠŸèƒ½æ­£ç¡®æ€§**:
- [ ] æŒ‰ `Ctrl+C` å¯ä»¥æ­£å¸¸é€€å‡º
- [ ] æ­£åœ¨å¤„ç†çš„è¯·æ±‚ä¼šå®Œæˆ(ä¸ä¼šè¢«å¼ºåˆ¶ä¸­æ–­)
- [ ] å…³é—­æ—¶æ—¥å¿—è¾“å‡ºå®Œæ•´(æ”¶åˆ°ä¿¡å· â†’ ä¼˜é›…å…³é—­ â†’ æ•°æ®åº“å…³é—­ â†’ å®Œå…¨åœæ­¢)
- [ ] æ•°æ®åº“æ–‡ä»¶æ²¡æœ‰æŸå(é‡å¯åå¯ä»¥æ­£å¸¸è¯»å–æ•°æ®)

**è¶…æ—¶å¤„ç†**:
- [ ] è¶…æ—¶æ—¶é—´è®¾ç½®ä¸º 30 ç§’
- [ ] è¶…æ—¶åä¼šå¼ºåˆ¶å…³é—­
- [ ] è¶…æ—¶æ—¥å¿—è®°å½•æ¸…æ™°

**ä¿¡å·å¤„ç†**:
- [ ] `SIGINT`(Ctrl+C) è§¦å‘ä¼˜é›…å…³é—­
- [ ] `SIGTERM`(kill) è§¦å‘ä¼˜é›…å…³é—­
- [ ] `SIGKILL`(kill -9) ç«‹å³é€€å‡º(æ— æ³•æ•è·,é¢„æœŸè¡Œä¸º)

**èµ„æºæ¸…ç†**:
- [ ] HTTP æœåŠ¡å™¨å…³é—­
- [ ] æ•°æ®åº“è¿æ¥å…³é—­
- [ ] æ²¡æœ‰ goroutine æ³„æ¼

---

## ğŸ’¡ å¸¸è§é—®é¢˜ FAQ

### Q1: ä¸ºä»€ä¹ˆä¸ç”¨ `http.ListenAndServe`?

**ç­”**:
```go
// âŒ æ— æ³•ä¼˜é›…å…³é—­
http.ListenAndServe(":7789", handler)

// âœ… å¯ä»¥è°ƒç”¨ Shutdown()
server := &http.Server{Addr: ":7789", Handler: handler}
go server.ListenAndServe()
// ... å¯ä»¥è°ƒç”¨ server.Shutdown()
```

### Q2: å¦‚ä½•å¤„ç†å¤šä¸ªèµ„æºçš„å…³é—­?

**ç­”**:
```go
// æŒ‰ä¾èµ–é¡ºåºå…³é—­
// 1. å…ˆå…³é—­å…¥å£(HTTP æœåŠ¡å™¨)
server.Shutdown(ctx)

// 2. å†å…³é—­ä¾èµ–èµ„æº
db.Close()
redis.Close()
messageQueue.Close()

// 3. æœ€åæ¸…ç†ä¸´æ—¶èµ„æº
os.RemoveAll(tmpDir)
```

### Q3: å¦‚ä½•æµ‹è¯• Kubernetes ä¸­çš„ä¼˜é›…å…³é—­?

**ç­”**:
```yaml
# deployment.yaml
spec:
  terminationGracePeriodSeconds: 30  # K8s ç­‰å¾…æ—¶é—´
  containers:
  - name: todo-server
    lifecycle:
      preStop:
        exec:
          command: ["/bin/sh", "-c", "sleep 5"]  # ç•™å‡ºæ—¶é—´è®©è´Ÿè½½å‡è¡¡æ‘˜é™¤
```

**æµç¨‹**:
1. Kubernetes æ ‡è®° Pod ä¸º Terminating
2. è´Ÿè½½å‡è¡¡åœæ­¢è½¬å‘æ–°è¯·æ±‚åˆ°è¯¥ Pod
3. æ‰§è¡Œ `preStop` hook(ç­‰å¾… 5 ç§’)
4. å‘é€ SIGTERM
5. åº”ç”¨ä¼˜é›…å…³é—­(æœ€å¤š 30 ç§’)
6. å¦‚æœè¶…æ—¶,å‘é€ SIGKILL

### Q4: å¦‚ä½•è®°å½•è¢«ä¸­æ–­çš„è¯·æ±‚?

**ç­”**:
```go
// ä½¿ç”¨ä¸­é—´ä»¶è®°å½•è¯·æ±‚å¼€å§‹/ç»“æŸ
func loggingMiddleware(next http.HandlerFunc) http.HandlerFunc {
    return func(w http.ResponseWriter, r *http.Request) {
        id := generateRequestID()
        log.Printf("[%s] è¯·æ±‚å¼€å§‹: %s %s", id, r.Method, r.URL.Path)

        next(w, r)

        log.Printf("[%s] è¯·æ±‚ç»“æŸ", id)
    }
}

// å…³é—­æ—¶,æ£€æŸ¥å“ªäº›è¯·æ±‚æœªç»“æŸ
// (éœ€è¦ç»´æŠ¤ä¸€ä¸ªæ´»è·ƒè¯·æ±‚çš„ map,ç•¥å¤æ‚)
```

---

## ğŸš€ å®ç°æ­¥éª¤å»ºè®®

**ç¬¬ 1 æ­¥**: ä¿®æ”¹ `cmd/server/main.go`,æ·»åŠ ä¿¡å·æ•è·

**ç¬¬ 2 æ­¥**: åœ¨ goroutine ä¸­å¯åŠ¨æœåŠ¡å™¨

**ç¬¬ 3 æ­¥**: å®ç°ä¼˜é›…å…³é—­é€»è¾‘

**ç¬¬ 4 æ­¥**: æ·»åŠ æ•°æ®åº“å…³é—­

**ç¬¬ 5 æ­¥**: æµ‹è¯• `Ctrl+C` å’Œ `kill` ä¿¡å·

---

## ğŸ“– æ‰©å±•é˜…è¯»

- [Go HTTP Server Graceful Shutdown](https://pkg.go.dev/net/http#Server.Shutdown)
- [Kubernetes Pod Lifecycle](https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/)
- [Linux Signals](https://man7.org/linux/man-pages/man7/signal.7.html)

---

**ç°åœ¨,å¼€å§‹å®ç°ä¼˜é›…å…³é—­å§!è®°ä½:ä¿¡å·æ•è·,å…ˆå…³æœåŠ¡å™¨,å†å…³æ•°æ®åº“ã€‚** ğŸš€
